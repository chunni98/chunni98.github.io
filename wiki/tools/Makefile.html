<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Makefile | CS Wiki</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="shachi 的 CS 知识库">
    
    <link rel="preload" href="/wiki/assets/css/0.styles.cf734400.css" as="style"><link rel="preload" href="/wiki/assets/js/app.a9cbc012.js" as="script"><link rel="preload" href="/wiki/assets/js/2.4b7299de.js" as="script"><link rel="preload" href="/wiki/assets/js/43.69a0a51c.js" as="script"><link rel="prefetch" href="/wiki/assets/js/10.023c6faa.js"><link rel="prefetch" href="/wiki/assets/js/11.7b506b9b.js"><link rel="prefetch" href="/wiki/assets/js/12.a18f7714.js"><link rel="prefetch" href="/wiki/assets/js/13.5355cffb.js"><link rel="prefetch" href="/wiki/assets/js/14.9a8f8fbb.js"><link rel="prefetch" href="/wiki/assets/js/15.b6b239d3.js"><link rel="prefetch" href="/wiki/assets/js/16.5cdec6d2.js"><link rel="prefetch" href="/wiki/assets/js/17.58c9759b.js"><link rel="prefetch" href="/wiki/assets/js/18.be401e1c.js"><link rel="prefetch" href="/wiki/assets/js/19.6f274486.js"><link rel="prefetch" href="/wiki/assets/js/20.a7a052f3.js"><link rel="prefetch" href="/wiki/assets/js/21.d3737ebb.js"><link rel="prefetch" href="/wiki/assets/js/22.0234a233.js"><link rel="prefetch" href="/wiki/assets/js/23.a887dc83.js"><link rel="prefetch" href="/wiki/assets/js/24.b72aebf9.js"><link rel="prefetch" href="/wiki/assets/js/25.bf72279a.js"><link rel="prefetch" href="/wiki/assets/js/26.48a912b9.js"><link rel="prefetch" href="/wiki/assets/js/27.d5457a55.js"><link rel="prefetch" href="/wiki/assets/js/28.2bd842a0.js"><link rel="prefetch" href="/wiki/assets/js/29.e9d02bfe.js"><link rel="prefetch" href="/wiki/assets/js/3.347cffd3.js"><link rel="prefetch" href="/wiki/assets/js/30.710f9039.js"><link rel="prefetch" href="/wiki/assets/js/31.6ddefe52.js"><link rel="prefetch" href="/wiki/assets/js/32.647383cd.js"><link rel="prefetch" href="/wiki/assets/js/33.6b5bbc55.js"><link rel="prefetch" href="/wiki/assets/js/34.cc3c8896.js"><link rel="prefetch" href="/wiki/assets/js/35.ed09c55f.js"><link rel="prefetch" href="/wiki/assets/js/36.a076c949.js"><link rel="prefetch" href="/wiki/assets/js/37.22e9ddb1.js"><link rel="prefetch" href="/wiki/assets/js/38.dc95d115.js"><link rel="prefetch" href="/wiki/assets/js/39.d795a7ba.js"><link rel="prefetch" href="/wiki/assets/js/4.e3173cf0.js"><link rel="prefetch" href="/wiki/assets/js/40.199dc79b.js"><link rel="prefetch" href="/wiki/assets/js/41.0d9b8a87.js"><link rel="prefetch" href="/wiki/assets/js/42.7f0c852a.js"><link rel="prefetch" href="/wiki/assets/js/44.892f6327.js"><link rel="prefetch" href="/wiki/assets/js/45.ce6f0ee1.js"><link rel="prefetch" href="/wiki/assets/js/46.dcc656cd.js"><link rel="prefetch" href="/wiki/assets/js/5.5b3fd24d.js"><link rel="prefetch" href="/wiki/assets/js/6.3b848e60.js"><link rel="prefetch" href="/wiki/assets/js/7.1d469969.js"><link rel="prefetch" href="/wiki/assets/js/8.18290f0f.js"><link rel="prefetch" href="/wiki/assets/js/9.2bb47d5a.js">
    <link rel="stylesheet" href="/wiki/assets/css/0.styles.cf734400.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/wiki/" class="home-link router-link-active"><img src="/wiki/favicon.ico" alt="CS Wiki" class="logo"> <span class="site-name can-hide">CS Wiki</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/wiki/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/wiki/archives/" class="nav-link">
  归档
</a></div><div class="nav-item"><a href="/wiki/c/" class="nav-link">
  C
</a></div><div class="nav-item"><a href="/wiki/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          理论
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/wiki/data-structure/" class="nav-link">
  数据结构
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/.html#" class="nav-link">
  计算机网络
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/.html#" class="nav-link">
  计算机组成原理
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/.html#" class="nav-link">
  操作系统
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/.html#" class="nav-link">
  数据库
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/.html#" class="nav-link">
  编译原理
</a></li></ul></li><li class="dropdown-item"><h4>
          工具
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/wiki/tools/vim.html" class="nav-link">
  Vim
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/Makefile.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Makefile
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/.html#" class="nav-link">
  shell
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/.html#" class="nav-link">
  正则表达式
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/git.html" class="nav-link">
  git
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/.html#" class="nav-link">
  python
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/gdb.html" class="nav-link">
  gdb
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="嵌入式" class="dropdown-title"><span class="title">嵌入式</span> <span class="arrow down"></span></button> <button type="button" aria-label="嵌入式" class="mobile-dropdown-title"><span class="title">嵌入式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wiki/tools/.html#" class="nav-link">
  x86汇编
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/sqlite3.html" class="nav-link">
  sqlite3
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/stm32/" class="nav-link">
  stm32
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/collections.html" class="nav-link">
  问题集
</a></li></ul></div></div><div class="nav-item"><a href="https://chunni98.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/wiki/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/wiki/archives/" class="nav-link">
  归档
</a></div><div class="nav-item"><a href="/wiki/c/" class="nav-link">
  C
</a></div><div class="nav-item"><a href="/wiki/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          理论
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/wiki/data-structure/" class="nav-link">
  数据结构
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/.html#" class="nav-link">
  计算机网络
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/.html#" class="nav-link">
  计算机组成原理
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/.html#" class="nav-link">
  操作系统
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/.html#" class="nav-link">
  数据库
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/.html#" class="nav-link">
  编译原理
</a></li></ul></li><li class="dropdown-item"><h4>
          工具
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/wiki/tools/vim.html" class="nav-link">
  Vim
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/Makefile.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Makefile
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/.html#" class="nav-link">
  shell
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/.html#" class="nav-link">
  正则表达式
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/git.html" class="nav-link">
  git
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/.html#" class="nav-link">
  python
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/gdb.html" class="nav-link">
  gdb
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="嵌入式" class="dropdown-title"><span class="title">嵌入式</span> <span class="arrow down"></span></button> <button type="button" aria-label="嵌入式" class="mobile-dropdown-title"><span class="title">嵌入式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wiki/tools/.html#" class="nav-link">
  x86汇编
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/sqlite3.html" class="nav-link">
  sqlite3
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/stm32/" class="nav-link">
  stm32
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/collections.html" class="nav-link">
  问题集
</a></li></ul></div></div><div class="nav-item"><a href="https://chunni98.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Makefile</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/wiki/tools/Makefile.html#makefile-介绍" class="sidebar-link">Makefile 介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#makefile-的规则" class="sidebar-link">Makefile 的规则</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#makefile-里有什么" class="sidebar-link">Makefile 里有什么？</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#引用其他-makefile" class="sidebar-link">引用其他 Makefile</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#环境变量" class="sidebar-link">环境变量</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#make-的工作方式" class="sidebar-link">Make 的工作方式</a></li></ul></li><li><a href="/wiki/tools/Makefile.html#书写规则" class="sidebar-link">书写规则</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#规则语法" class="sidebar-link">规则语法</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#通配符" class="sidebar-link">通配符</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#文件搜寻" class="sidebar-link">文件搜寻</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#伪目标" class="sidebar-link">伪目标</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#多目标" class="sidebar-link">多目标</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#静态模式" class="sidebar-link">静态模式</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#自动生成依赖性" class="sidebar-link">自动生成依赖性</a></li></ul></li><li><a href="/wiki/tools/Makefile.html#书写命令" class="sidebar-link">书写命令</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#命令执行" class="sidebar-link">命令执行</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#命令出错" class="sidebar-link">命令出错</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#嵌套执行-make" class="sidebar-link">嵌套执行 Make</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#定义命令包" class="sidebar-link">定义命令包</a></li></ul></li><li><a href="/wiki/tools/Makefile.html#使用变量" class="sidebar-link">使用变量</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#变量基础" class="sidebar-link">变量基础</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#变量中的变量" class="sidebar-link">变量中的变量</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#变量的高级用法" class="sidebar-link">变量的高级用法</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#追加变量值" class="sidebar-link">追加变量值</a></li></ul></li><li><a href="/wiki/tools/Makefile.html#函数" class="sidebar-link">函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#字符串处理函数" class="sidebar-link">字符串处理函数</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#文件名操作函数" class="sidebar-link">文件名操作函数</a></li></ul></li><li><a href="/wiki/tools/Makefile.html#make-的运行" class="sidebar-link">Make 的运行</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#常见伪目标" class="sidebar-link">常见伪目标：</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#选项" class="sidebar-link">选项</a></li></ul></li><li><a href="/wiki/tools/Makefile.html#隐含规则" class="sidebar-link">隐含规则</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#命令变量" class="sidebar-link">命令变量</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#命令参数的变量" class="sidebar-link">命令参数的变量</a></li><li class="sidebar-sub-header"><a href="/wiki/tools/Makefile.html#自动化变量" class="sidebar-link">自动化变量</a></li></ul></li><li><a href="/wiki/tools/Makefile.html#参考" class="sidebar-link">参考</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="makefile-介绍"><a href="#makefile-介绍" class="header-anchor">#</a> Makefile 介绍</h2> <h3 id="makefile-的规则"><a href="#makefile-的规则" class="header-anchor">#</a> Makefile 的规则</h3> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token target symbol">&lt;target&gt;</span> <span class="token punctuation">:</span> &lt;prerequisites&gt;
[tab]  &lt;commands&gt;
    ...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><code>target</code> 目标，可以是执行文件，也可以是一个标签。</li> <li><code>prerequisites</code> 生成 <code>target</code> 所依赖的文件或 <code>target</code>。</li> <li><code>command</code> 该 <code>target</code> 要执行的命令。</li></ul> <p><strong>prerequisites中如果有一个以上的文件比target文件要新的话，command所定义的命令就会被执行。</strong></p> <h3 id="makefile-里有什么"><a href="#makefile-里有什么" class="header-anchor">#</a> Makefile 里有什么？</h3> <p>Makefile 里主要包含了五个东西：显式规则、隐晦规则、变量定义、文件指示和注释。</p> <ol><li>显式规则。显式规则说明了如何生成一个或多个目标文件。这是由 Makefile 的书写者明显指出要
生成的文件、文件的依赖文件和生成的命令。</li> <li>隐晦规则。由于我们的 make 有自动推导的功能，所以隐晦的规则可以让我们比较简略地书写 Makefile，这是由 make 所支持的。</li> <li>变量的定义。在 Makefile 中我们要定义一系列的变量，变量一般都是字符串，这个有点像你 C 语
言中的宏，当 Makefile 被执行时，其中的变量都会被扩展到相应的引用位置上。</li> <li>文件指示。其包括了三个部分，一个是在一个 Makefile 中引用另一个 Makefile，就像 C 语言中的
include 一样；另一个是指根据某些情况指定 Makefile 中的有效部分，就像 C 语言中的预编译 #if
一样；还有就是定义一个多行的命令。有关这一部分的内容，我会在后续的部分中讲述。</li> <li>注释。Makefile 中只有行注释，和 UNIX 的 Shell 脚本一样，其注释是用 # 字符，这个就像 C/C++
中的 // 一样。如果你要在你的 Makefile 中使用 # 字符，可以用反斜杠进行转义，如：<code>\#</code> 。
最后，还值得一提的是，在 Makefile 中的命令，必须要以 Tab 键开始。</li></ol> <h3 id="引用其他-makefile"><a href="#引用其他-makefile" class="header-anchor">#</a> 引用其他 Makefile</h3> <p><code>include &lt;filename&gt;</code></p> <p>filename 可以是当前操作系统 Shell 的文件模式（可以包含路径和通配符）。</p> <p>make 命令开始时，会找寻 include 所指出的其它 Makefile，并把其内容安置在当前的位置。</p> <p><code>-I</code> 选项指定查找目录。</p> <h3 id="环境变量"><a href="#环境变量" class="header-anchor">#</a> 环境变量</h3> <p>如果你的当前环境中定义了环境变量 MAKEFILES ，那么，make 会把这个变量中的值做一个类似于
include 的动作。</p> <p>建议不要使用。</p> <h3 id="make-的工作方式"><a href="#make-的工作方式" class="header-anchor">#</a> Make 的工作方式</h3> <p>GNU 的 make 工作时的执行步骤如下：</p> <ol><li>读入所有的 Makefile。</li> <li>读入被 include 的其它 Makefile。</li> <li>初始化文件中的变量。</li> <li>推导隐晦规则，并分析所有规则。</li> <li>为所有的目标文件创建依赖关系链。</li> <li>根据依赖关系，决定哪些目标要重新生成。</li> <li>执行生成命令。</li></ol> <h2 id="书写规则"><a href="#书写规则" class="header-anchor">#</a> 书写规则</h2> <p>规则包含两个部分，一个是依赖关系，一个是生成目标的方法。</p> <p>一般来说，定义在 Makefile中的第一条规则中的目标将被确立为最终的目标。</p> <h3 id="规则语法"><a href="#规则语法" class="header-anchor">#</a> 规则语法</h3> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token target symbol">&lt;target&gt;</span> <span class="token punctuation">:</span> &lt;prerequisites&gt;
[tab]  &lt;commands&gt;
    ...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><code>target</code> 目标，可以是执行文件，也可以是一个标签。</li> <li><code>prerequisites</code> 生成 <code>target</code> 所依赖的文件或 <code>target</code>。</li> <li><code>command</code> 该 <code>target</code> 要执行的命令。</li></ul> <p>如果命令太长，你可以使用反斜杠（\ ）作为换行符。</p> <h3 id="通配符"><a href="#通配符" class="header-anchor">#</a> 通配符</h3> <p>make 支持三个通配符：<code>*</code> ，<code>?</code> 和 <code>~</code> 。</p> <p><code>~</code> 表示用户的 <code>$HOME</code> 目录。</p> <p>如果要将通配符用于变量中，需要这样写：</p> <p><code>objects := $(wildcast *.o)</code></p> <p>列出一确定文件夹中的所有 <code>.c</code> 文件：</p> <p><code>objects := $(wildcard *.c)</code></p> <p>列出文件对应的 <code>.o</code> 文件：</p> <p><code>$(patsubst %.c %.o, $(wildcard, *.c))</code></p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code>objects <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">patsubst</span> %.c,%.o, <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">wildcard</span> *.c<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token target symbol">foo</span><span class="token punctuation">:</span> <span class="token variable">$</span><span class="token punctuation">(</span>objects<span class="token punctuation">)</span>
    cc -o foo <span class="token variable">$</span><span class="token punctuation">(</span>objects<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="文件搜寻"><a href="#文件搜寻" class="header-anchor">#</a> 文件搜寻</h3> <p>当 make 需要去找寻文件的依赖关系时，你可以在文件前加上路径，但最好的方法是把一个路径告诉 make，让 make 在自动去找。</p> <p>Makefile 文件中的特殊变量 VPATH 就是完成这个功能的，如果没有指明这个变量，make 只会在当前的目录中去找寻依赖文件和目标文件。</p> <p><code>VPATH = src:../headers</code></p> <p>上面的定义指定两个目录，“src”和“../headers”，make 会按照这个顺序进行搜索。目录由“冒号”分隔。</p> <p><strong>vpath 关键字</strong></p> <p><code>vpath &lt;pattern&gt; &lt;directories&gt;</code></p> <p>为符合模式<code>&lt;pattern&gt;</code> 的文件指定搜索目录 <code>&lt;directories&gt;</code>。</p> <p><code>vpath &lt;pattern&gt;</code></p> <p>清除符合模式<code>&lt;pattern&gt;</code> 的文件的搜索目录。</p> <p><code>vpath</code> 清除所有设置好的文件搜索目录。</p> <p>vpath 使用方法中的 <code>&lt;pattern&gt;</code> 需要包含 % 字符。% 的意思是匹配零或若干字符</p> <p><code>vpath %.h ../headers</code></p> <p>该语句表示，要求 make 在“../headers”目录下搜索所有以 .h 结尾的文件。</p> <h3 id="伪目标"><a href="#伪目标" class="header-anchor">#</a> 伪目标</h3> <p>“伪目标”并不是一个文件，只是一个标签，需要显式指明才能让其生效。为了避免和文件重名，需要使用特殊标记：</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> clean
<span class="token target symbol">clean</span><span class="token punctuation">:</span>
    rm  -f *.o temp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>可以利用伪目标一次性生成多个目标：</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token builtin-target builtin">.PHONY</span> <span class="token punctuation">:</span> all
<span class="token target symbol">all</span> <span class="token punctuation">:</span> prog1 prog2 prog3

<span class="token target symbol">prog1</span> <span class="token punctuation">:</span> prog1.o utils.o
    cc -o prog1 prog1.o utils.o

<span class="token target symbol">prog2</span> <span class="token punctuation">:</span> prog2.o
    cc -o prog2 prog2.o

<span class="token target symbol">prog3</span> <span class="token punctuation">:</span> prog3.o sort.o utils.o
    cc -o prog3 prog3.o sort.o utils.o
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>伪目标也可以是依赖：</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> cleanall cleanobj cleandiff

<span class="token target symbol">cleanall</span><span class="token punctuation">:</span> cleanobj cleandiff
    rm program

<span class="token target symbol">cleanobj</span><span class="token punctuation">:</span>
    rm *.o

<span class="token target symbol">cleandiff</span><span class="token punctuation">:</span>
    rm *.diff
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="多目标"><a href="#多目标" class="header-anchor">#</a> 多目标</h3> <p>Makefile 的规则中的目标可以不止一个，其支持多目标，有可能我们的多个目标同时依赖于一个文件，并且其生成的命令大体类似。于是我们就能把其合并起来。</p> <div class="language-Makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token target symbol">bigoutput littleoutput</span><span class="token punctuation">:</span> text.g
    generate text.g -<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">subst</span> output,,<span class="token variable">$@</span><span class="token punctuation">)</span> &gt; <span class="token variable">$@</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>等价于：</p> <div class="language-Makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token target symbol">bigoutoutput</span><span class="token punctuation">:</span> text.g
    generate text.g -big &gt; bigoutput

<span class="token target symbol">littleoutput</span><span class="token punctuation">:</span> text.g
    generate text.g -little &gt; littleoutput
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="静态模式"><a href="#静态模式" class="header-anchor">#</a> 静态模式</h3> <p>静态目标可以更容易地定义多目标的规则。</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token target symbol">&lt;targets ...&gt;</span> <span class="token punctuation">:</span> &lt;target-pattern&gt; <span class="token punctuation">:</span> &lt;prereq-patterns ...&gt;
    &lt;commands&gt;
    ...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>targets 定义了一系列的目标文件，可以有通配符。是目标的一个集合。</p> <p>target-pattern 是指明了 targets 的模式，也就是的目标集模式。</p> <p>prereq-patterns 是目标的依赖模式，它对 target-pattern 形成的模式再进行一次依赖目标的定义。</p> <p>例子：</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code>CC <span class="token operator">=</span> gcc
CFLAGS <span class="token operator">=</span> -Wall -Werror -g -O0

OBJS <span class="token operator">:=</span> foo.o bar.o

<span class="token target symbol">all</span><span class="token punctuation">:</span> <span class="token variable">$</span><span class="token punctuation">(</span>OBJS<span class="token punctuation">)</span>

<span class="token target symbol"><span class="token variable">$</span>(OBJS)</span><span class="token punctuation">:</span> %.o <span class="token punctuation">:</span> %.c
    <span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>CFLAGS<span class="token punctuation">)</span> -o <span class="token variable">$@</span> -c <span class="token variable">$&lt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>%.o</code> 指明我们的目标从 <code>OBJS</code> 中获取所有以 <code>.o</code> 结尾的目标，<code>%.c</code> 则取 <code>%</code> 匹配的内容，加上 <code>.c</code> 的后缀。</p> <p>依赖目标就变为 <code>foo.c bar.c</code></p> <p>上面例子等价于</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code>CC <span class="token operator">=</span> gcc
CFLAGS <span class="token operator">=</span> -Wall -Werror -g -O0

<span class="token target symbol">foo.o</span> <span class="token punctuation">:</span> foo.c
    <span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> -o <span class="token variable">$@</span> <span class="token variable">$</span><span class="token punctuation">(</span>FLAGS<span class="token punctuation">)</span> -c <span class="token variable">$&lt;</span>

<span class="token target symbol">bar.o</span> <span class="token punctuation">:</span> bar.c
    <span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> -o <span class="token variable">$@</span> <span class="token variable">$</span><span class="token punctuation">(</span>FLAGS<span class="token punctuation">)</span> -c <span class="token variable">$&lt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>例子二：</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code>files <span class="token operator">=</span> foo.elc bar.o lose.o

<span class="token target symbol"><span class="token variable">$</span>(filter %.o, <span class="token variable">$</span>(files))</span> <span class="token punctuation">:</span> %.o <span class="token punctuation">:</span> %.c
    <span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> -c <span class="token variable">$</span><span class="token punctuation">(</span>CFLAGS<span class="token punctuation">)</span> <span class="token variable">$&lt;</span> -o <span class="token variable">$@</span>

<span class="token target symbol"><span class="token variable">$</span>(filter %.o, <span class="token variable">$</span>(files))</span> <span class="token punctuation">:</span> %.o <span class="token punctuation">:</span> %.c
    emacs -f batch-byte-compile <span class="token variable">$&lt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>$(filter %.o $(files))</code> 表明调用 makefile 的 <code>filter</code> 函数，过滤 <code>$(files)</code> 集。只要其中模式为 <code>%.o</code> 的内容。</p> <h3 id="自动生成依赖性"><a href="#自动生成依赖性" class="header-anchor">#</a> 自动生成依赖性</h3> <p>太复杂，跳过，以后用到再学。</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token target symbol">%.d</span><span class="token punctuation">:</span> %.c
    <span class="token operator">@</span>set -e<span class="token punctuation">;</span> rm -f <span class="token variable">$@;</span> \
    <span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> -M <span class="token variable">$</span><span class="token punctuation">(</span>CPPFLAGS<span class="token punctuation">)</span> <span class="token variable">$&lt;</span> &gt; <span class="token variable">$@.$$$$;</span> \
    sed <span class="token string">'s,\($*\)\.o[ :]*,\1.o $@ : ,g'</span> &lt; <span class="token variable">$@.$$$$</span> &gt; <span class="token variable">$@;</span> \
    rm -f <span class="token variable">$@.$$$$</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这个规则的意思是，所有的 <code>.d</code> 文件依赖于 <code>.c</code> 文件，<code>rm -f $@</code> 的意思是删除所有的目标，也就是
<code>.d</code> 文件，第二行的意思是，为每个依赖文件 <code>$&lt;</code> ，也就是 <code>.c</code> 文件生成依赖文件，<code>$@</code> 表示模式 <code>%.d</code> 文件，
如果有一个 C 文件是 name.c，那么 % 就是 name ，$$$$ 意为一个随机编号，第二行生成的文件有可能
是“name.d.12345”，第三行使用 sed 命令做了一个替换</p> <p>这个模式要做的事就是在编译器生成的依赖关系中加入 .d 文件的依赖，即把依赖关系</p> <p><code>main.o : main.c defs.h</code></p> <p>转成</p> <p><code>main.o main.d : main.c defs.h</code></p> <h2 id="书写命令"><a href="#书写命令" class="header-anchor">#</a> 书写命令</h2> <p><code>@</code> 屏蔽回显。</p> <p><code>-n</code> 参数，只打印，不执行。</p> <p><code>-s</code> silent 只执行不打印。</p> <h3 id="命令执行"><a href="#命令执行" class="header-anchor">#</a> 命令执行</h3> <p>如果需要上一条的命令应用在下一条命令时，写在同一行，并用 <code>;</code> 分隔。</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token target symbol">exec</span><span class="token punctuation">:</span>
    cd /home/hchen<span class="token punctuation">;</span> pwd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="命令出错"><a href="#命令出错" class="header-anchor">#</a> 命令出错</h3> <p>命令执行完后，make 会检测每个命令的返回码。</p> <p>为了忽略命令的出错，可在命令行前加上一个 <code>-</code> 号。</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token target symbol">clean</span><span class="token punctuation">:</span>
    -rm -f *.o
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="嵌套执行-make"><a href="#嵌套执行-make" class="header-anchor">#</a> 嵌套执行 Make</h3> <p>举例：</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token target symbol">subsystem</span><span class="token punctuation">:</span>
    <span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> -C subdir
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>表示进入 <code>subdir</code> 目录，执行 <code>make</code> 命令。</p> <p>传递变量给下级的 <code>Makefile</code>。</p> <p><code>export &lt;variable ...&gt;</code></p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code>variable <span class="token operator">=</span> value
<span class="token keyword">export</span> variable
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>传递所有变量，只要一个 <code>export</code> 就行。</p> <p>有两个变量，一个是 SHELL ，一个是 MAKEFLAGS ，这两个变量不管你是否 export，其总是要传递到下层 Makefile 中</p> <p>如果我们在执行 <code>make</code> 时，有参数，那么 <code>MAKEFLAGS</code> 变量会将这些参数传递到下层 Makefile，这是系统级的环境变量。</p> <p>但是 make 命令中的有几个参数并不往下传递，它们是 -C , -f , -h, -o 和 -W</p> <p>如果不想往下传参数，可以这样写：</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token target symbol">subsystem</span><span class="token punctuation">:</span>
    cd substr &amp;&amp; <span class="token variable">$</span><span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> MAKEFLAGS<span class="token operator">=</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="定义命令包"><a href="#定义命令包" class="header-anchor">#</a> 定义命令包</h3> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token keyword">define</span> run-yacc
yacc <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">firstword</span> <span class="token variable">$^</span><span class="token punctuation">)</span>
mv y.tab.c <span class="token variable">$@</span>
<span class="token keyword">endef</span>

<span class="token target symbol">foo.c</span> <span class="token punctuation">:</span> foo.y
    <span class="token variable">$</span><span class="token punctuation">(</span>run-yacc<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="使用变量"><a href="#使用变量" class="header-anchor">#</a> 使用变量</h2> <p>类似于 C 中的宏。</p> <p>自定义变量建议不要全大写，首字母大写，避免和系统变量冲突。</p> <h3 id="变量基础"><a href="#变量基础" class="header-anchor">#</a> 变量基础</h3> <p>使用变量需要用 <code>$()</code> 包裹。</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code>Objects <span class="token operator">=</span> program.o foo.o utils.o

<span class="token target symbol">program</span> <span class="token punctuation">:</span> <span class="token variable">$</span><span class="token punctuation">(</span>Objests<span class="token punctuation">)</span>
    cc -o program <span class="token variable">$</span><span class="token punctuation">(</span>Objects<span class="token punctuation">)</span>

<span class="token target symbol"><span class="token variable">$</span>(Objects)</span> <span class="token punctuation">:</span> defs.h
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>例如：</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code>foo <span class="token operator">=</span> c

<span class="token target symbol">prog.o</span> <span class="token punctuation">:</span> prog.<span class="token variable">$</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span>
    <span class="token variable">$</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token variable">$</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span> -<span class="token variable">$</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span> prog.<span class="token variable">$</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="变量中的变量"><a href="#变量中的变量" class="header-anchor">#</a> 变量中的变量</h3> <p>延时变量表示：使用该变量的时候，才展开该变量，并确定该变量的值</p> <p>立即变量表示：定义的时候就已经确定了该变量的值</p> <p><code>=</code> 递归赋值。</p> <p><code>:=</code> 赋值。</p> <p>碰到变量需要展开，如果是<code>=</code>，则先往后面查找，如果是<code>:=</code>，则先往前面查找</p> <p><code>?=</code> 如果没有被赋值才赋值</p> <h3 id="变量的高级用法"><a href="#变量的高级用法" class="header-anchor">#</a> 变量的高级用法</h3> <p><strong>变量值的替换</strong></p> <p><code>$(var:a=b)</code> 把变量 &quot;var&quot; 中所有以 'a' 字符串结尾的 'a' 替换为 'b' 。</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code>foo <span class="token operator">:=</span> a.o b.o c.o
bar <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span>foo<span class="token punctuation">:</span>.o<span class="token operator">=</span>.c<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>把变量的值当作变量：</p> <p><code>$($(x))</code></p> <p>静态模式替换：</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code>foo <span class="token operator">:=</span> a.o b.o c.o
bar <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span>foo<span class="token punctuation">:</span> %.o<span class="token operator">=</span>%.c<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="追加变量值"><a href="#追加变量值" class="header-anchor">#</a> 追加变量值</h3> <p><code>+=</code> 以<code>:=</code> 作为赋值符。</p> <h2 id="函数"><a href="#函数" class="header-anchor">#</a> 函数</h2> <p>函数调用：</p> <p><code>$(&lt;function&gt; &lt;arguments&gt;)</code> 参与用逗号分隔。</p> <h3 id="字符串处理函数"><a href="#字符串处理函数" class="header-anchor">#</a> 字符串处理函数</h3> <p><strong>subst</strong></p> <p><code>$(sbust &lt;from&gt;,&lt;to&gt;,&lt;text&gt;)</code></p> <p><code>$(subst ee,EE,feet on the street)</code></p> <p><strong>patsubst</strong></p> <p><code>$(patsubst &lt;pattern&gt;,&lt;replacement&gt;,&lt;text&gt;)</code></p> <p><code>$(patsubst %.c,%.o,x.c bar.c )</code></p> <h3 id="文件名操作函数"><a href="#文件名操作函数" class="header-anchor">#</a> 文件名操作函数</h3> <p><strong>dir</strong></p> <p><code>$(dir &lt;names...&gt;)</code></p> <p><code>$(dir src/foo.c hacks)</code> 返回值是 <code>src/ ./</code>。</p> <p><strong>notdir</strong></p> <p><code>$(not dir src/foo.c hacks)</code> 返回值是 <code>foo.c hacks</code>。</p> <p><strong>wildcard</strong></p> <p><code>$(patsubst %.c,%.o,$(wildcard *.c))</code>，首先使用“wildcard”函数获取工作目录下的.c文件列表；之后将列表中所有文件名的后缀.c替换为.o。</p> <h2 id="make-的运行"><a href="#make-的运行" class="header-anchor">#</a> Make 的运行</h2> <p><code>-f</code> 指定 make。</p> <h3 id="常见伪目标"><a href="#常见伪目标" class="header-anchor">#</a> 常见伪目标：</h3> <ul><li>all：所有目标。</li> <li>clean：清理。</li> <li>install；安装编译好的程序，其实就是把目标执行文件拷贝到指定的目标中去。</li> <li>print：列出所有改变过的源文件。</li> <li>tar：把源代码打包备份成一个 tar 文件。</li> <li>dist：创建一个压缩文件，一般是<code>xz</code>文件。</li> <li>TAGS:更新所有的目标，以备完整编译使用。</li> <li>check 和 test，测试用。</li></ul> <h3 id="选项"><a href="#选项" class="header-anchor">#</a> 选项</h3> <ul><li><code>-n</code>打印不执行。</li> <li><code>-B</code> 重编译所有目标。</li> <li><code>-C</code> 指定读取 makefile 的目录。如果有多个“-C”参数，make 的解释是后面的路径以前面的作为相对路径，并以最后的目录作为被指定目录。如：“make -C ~hchen/test -C prog”等价于“make -C hchen/test/prog”。</li></ul> <h2 id="隐含规则"><a href="#隐含规则" class="header-anchor">#</a> 隐含规则</h2> <p>例如，把 .c 文件编译成 .o 文件这一规则，你根本就不用写出来，make 会自动推导出这种规则，并生成我们需要的 .o 文件。</p> <p>make 调用的隐含规则是，把 .o 的目标的依赖文件置成 .c ，并使用 C 的编译命令 <code>cc –c $(CFLAGS) foo.c</code> 来生成 foo.o 的目标。</p> <p>隐含规则一览：</p> <ol><li>编译 C 程序的隐含规则。<code>&lt;n&gt;.o</code> 的目标的依赖目标会自动推导为 <code>&lt;n&gt;.c</code> ，并且其生成命令是 <code>$(CC) –c $(CPPFLAGS) $(CFLAGS)</code></li> <li>编译 C++ 程序的隐含规则。<code>&lt;n&gt;.o</code> 的目标的依赖目标会自动推导为 <code>&lt;n&gt;.cc</code> 或是 <code>&lt;n&gt;.C</code> ，并且其生成命令是 <code>$(CXX) –c $(CPPFLAGS) $(CXXFLAGS)</code> 。（建议使用 .cc 作为 C++ 源文件的后缀，而不是 .C ）</li></ol> <h3 id="命令变量"><a href="#命令变量" class="header-anchor">#</a> 命令变量</h3> <ul><li>AR : 函数库打包程序。默认命令是 ar</li> <li>AS : 汇编语言编译程序。默认命令是 as</li> <li>CC : C 语言编译程序。默认命令是 cc</li> <li>CXX : C++ 语言编译程序。默认命令是 g++</li> <li>CO : 从 RCS 文件中扩展文件程序。默认命令是 co</li> <li>CPP : C 程序的预处理器（输出是标准输出设备）。默认命令是 $(CC) –E</li> <li>FC : Fortran 和 Ratfor 的编译器和预处理程序。默认命令是 f77</li> <li>GET : 从 SCCS 文件中扩展文件的程序。默认命令是 get</li> <li>LEX : Lex 方法分析器程序（针对于 C 或 Ratfor）。默认命令是 lex</li> <li>PC : Pascal 语言编译程序。默认命令是 pc</li> <li>YACC : Yacc 文法分析器（针对于 C 程序）。默认命令是 yacc</li> <li>YACCR : Yacc 文法分析器（针对于 Ratfor 程序）。默认命令是 yacc –r</li> <li>MAKEINFO : 转换 Texinfo 源文件（.texi）到 Info 文件程序。默认命令是 makeinfo</li> <li>TEX : 从 TeX 源文件创建 TeX DVI 文件的程序。默认命令是 tex</li> <li>TEXI2DVI : 从 Texinfo 源文件创建军 TeX DVI 文件的程序。默认命令是 texi2dvi</li> <li>WEAVE : 转换 Web 到 TeX 的程序。默认命令是 weave</li> <li>CWEAVE : 转换 C Web 到 TeX 的程序。默认命令是 cweave</li> <li>TANGLE : 转换 Web 到 Pascal 语言的程序。默认命令是 tangle</li> <li>CTANGLE : 转换 C Web 到 C。默认命令是 ctangle</li> <li>RM : 删除文件命令。默认命令是 rm –f</li></ul> <h3 id="命令参数的变量"><a href="#命令参数的变量" class="header-anchor">#</a> 命令参数的变量</h3> <ul><li>ARFLAGS : 函数库打包程序 AR 命令的参数。默认值是 rv</li> <li>ASFLAGS : 汇编语言编译器参数。（当明显地调用 .s 或 .S 文件时）</li> <li>CFLAGS : C 语言编译器参数。</li> <li>CXXFLAGS : C++ 语言编译器参数。</li> <li>COFLAGS : RCS 命令参数。</li> <li>CPPFLAGS : C 预处理器参数。（C 和 Fortran 编译器也会用到）。</li> <li>FFLAGS : Fortran 语言编译器参数。</li> <li>GFLAGS : SCCS “get”程序参数。</li> <li>LDFLAGS : 链接器参数。（如：ld ）</li> <li>LFLAGS : Lex 文法分析器参数。</li> <li>PFLAGS : Pascal 语言编译器参数。</li> <li>RFLAGS : Ratfor 程序的 Fortran 编译器参数。</li> <li>YFLAGS : Yacc 文法分析器参数。</li></ul> <h3 id="自动化变量"><a href="#自动化变量" class="header-anchor">#</a> 自动化变量</h3> <ul><li><code>$@</code> : 表示规则中的目标文件集。在模式规则中，如果有多个目标，那么，$@ 就是匹配于目标中模式定义的集合。</li> <li><code>$%</code> : 仅当目标是函数库文件中，表示规则中的目标成员名。例如，如果一个目标是 foo.a(bar.o)- 那么，<code>$%</code> 就是 bar.o ，$@ 就是 foo.a 。如果目标不是函数库文件（Unix 下是 .a ，Windows下是 .lib ），那么，其值为空。</li> <li><code>$&lt;</code> : 依赖目标中的第一个目标名字。如果依赖目标是以模式（即 % ）定义的，那么 $&lt; 将是符合模式的一系列的文件集。注意，其是一个一个取出来的。</li> <li><code>$?</code> : 所有比目标新的依赖目标的集合。以空格分隔。</li> <li><code>$^</code> : 所有的依赖目标的集合。以空格分隔。如果在依赖目标中有多个重复的，那么这个变量会去除重复的依赖目标，只保留一份。</li> <li><code>$+</code> : 这个变量很像 $^ ，也是所有依赖目标的集合。只是它不去除重复的依赖目标。</li> <li><code>$*</code> : 这个变量表示目标模式中 % 及其之前的部分。如果目标是 dir/a.foo.b ，并且目标的模式是a.%.b ，那么，$* 的值就是 dir/foo 。这个变量对于构造有关联的文件名是比较有效。如果目标中没有模式的定义，那么 $* 也就不能被推导出，但是，如果目标文件的后缀是 make 所识别的，那么 $* 就是除了后缀的那一部分。例如：如果目标是 foo.c ，因为 .c 是 make 所能识别的后缀名，所以，$* 的值就是 foo 。这个特性是 GNU make 的，很有可能不兼容于其它版本的 make，所以，你应该尽量避免使用 $* ，除非是在隐含规则或是静态模式中。如果目标中的后缀是 make 所不能识别的，那么 $* 就是空值。</li></ul> <p>打包：</p> <div class="language-makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token target symbol">lib</span> <span class="token punctuation">:</span> foo.o bar.o lose.o win.o
    ar r lib <span class="token variable">$?</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>四个变量（<code>$@</code> 、<code>$&lt;</code> 、<code>$%</code> 、<code>$*</code> ）在扩展时只会有一个文件，另外三个是文件列表。</p> <ul><li><code>$(@D</code>)表示 $@ 的目录部分（不以斜杠作为结尾），如果 $@ 值是 dir/foo.o ，那么 $(@D) 就是 dir ，而如果 $@ 中没有包含斜杠的话，其值就是 . （当前目录）。</li> <li><code>$(@F)</code>表示 $@ 的文件部分，如果 $@ 值是 dir/foo.o ，那么 $(@F) 就是 foo.o ，$(@F) 相当于函数$(notdir $@) 。</li> <li><code>$(*D)</code>, <code>$(*F)</code>和上面所述的同理，也是取文件的目录部分和文件部分。对于上面的那个例子，<code>$(*D)</code> 返回 <code>dir</code> ，而 <code>$(*F)</code> 返回 foo</li> <li><code>$(%D)</code>, $(%F)分别表示了函数包文件成员的目录部分和文件部分。这对于形同 archive(member) 形式的目标中的 member 中包含了不同的目录很有用。</li> <li><code>$(&lt;D)</code>, <code>$(&lt;F)</code>分别表示依赖文件的目录部分和文件部分。</li> <li><code>$(^D)</code>, $(^F)分别表示所有依赖文件的目录部分和文件部分。（无相同的）</li> <li><code>$(+D)</code>, $(+F)分别表示所有依赖文件的目录部分和文件部分。（可以有相同的）</li> <li><code>$(?D)</code>, $(?F)分别表示被更新的依赖文件的目录部分和文件部分。</li></ul> <p>最后想提醒一下的是，对于 <code>$&lt;</code> ，为了避免产生不必要的麻烦，我们最好给 $ 后面的那个特定字符
都加上圆括号，比如，<code>$(&lt;)</code> 就要比 <code>$&lt;</code> 要好一些。</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <p><a href="https://seisman.github.io/how-to-write-makefile/rules.html" target="_blank" rel="noopener noreferrer">陈皓-跟我一起写 Makefile<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">2023/3/11 18:04:47</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/wiki/assets/js/app.a9cbc012.js" defer></script><script src="/wiki/assets/js/2.4b7299de.js" defer></script><script src="/wiki/assets/js/43.69a0a51c.js" defer></script>
  </body>
</html>
