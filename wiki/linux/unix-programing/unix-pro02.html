<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>02 多进程编程 | CS Wiki</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="shachi 的 CS 知识库">
    
    <link rel="preload" href="/wiki/assets/css/0.styles.cf734400.css" as="style"><link rel="preload" href="/wiki/assets/js/app.a9cbc012.js" as="script"><link rel="preload" href="/wiki/assets/js/2.4b7299de.js" as="script"><link rel="preload" href="/wiki/assets/js/12.a18f7714.js" as="script"><link rel="prefetch" href="/wiki/assets/js/10.023c6faa.js"><link rel="prefetch" href="/wiki/assets/js/11.7b506b9b.js"><link rel="prefetch" href="/wiki/assets/js/13.5355cffb.js"><link rel="prefetch" href="/wiki/assets/js/14.9a8f8fbb.js"><link rel="prefetch" href="/wiki/assets/js/15.b6b239d3.js"><link rel="prefetch" href="/wiki/assets/js/16.5cdec6d2.js"><link rel="prefetch" href="/wiki/assets/js/17.58c9759b.js"><link rel="prefetch" href="/wiki/assets/js/18.be401e1c.js"><link rel="prefetch" href="/wiki/assets/js/19.6f274486.js"><link rel="prefetch" href="/wiki/assets/js/20.a7a052f3.js"><link rel="prefetch" href="/wiki/assets/js/21.d3737ebb.js"><link rel="prefetch" href="/wiki/assets/js/22.0234a233.js"><link rel="prefetch" href="/wiki/assets/js/23.a887dc83.js"><link rel="prefetch" href="/wiki/assets/js/24.b72aebf9.js"><link rel="prefetch" href="/wiki/assets/js/25.bf72279a.js"><link rel="prefetch" href="/wiki/assets/js/26.48a912b9.js"><link rel="prefetch" href="/wiki/assets/js/27.d5457a55.js"><link rel="prefetch" href="/wiki/assets/js/28.2bd842a0.js"><link rel="prefetch" href="/wiki/assets/js/29.e9d02bfe.js"><link rel="prefetch" href="/wiki/assets/js/3.347cffd3.js"><link rel="prefetch" href="/wiki/assets/js/30.710f9039.js"><link rel="prefetch" href="/wiki/assets/js/31.6ddefe52.js"><link rel="prefetch" href="/wiki/assets/js/32.647383cd.js"><link rel="prefetch" href="/wiki/assets/js/33.6b5bbc55.js"><link rel="prefetch" href="/wiki/assets/js/34.cc3c8896.js"><link rel="prefetch" href="/wiki/assets/js/35.ed09c55f.js"><link rel="prefetch" href="/wiki/assets/js/36.a076c949.js"><link rel="prefetch" href="/wiki/assets/js/37.22e9ddb1.js"><link rel="prefetch" href="/wiki/assets/js/38.dc95d115.js"><link rel="prefetch" href="/wiki/assets/js/39.d795a7ba.js"><link rel="prefetch" href="/wiki/assets/js/4.e3173cf0.js"><link rel="prefetch" href="/wiki/assets/js/40.199dc79b.js"><link rel="prefetch" href="/wiki/assets/js/41.0d9b8a87.js"><link rel="prefetch" href="/wiki/assets/js/42.7f0c852a.js"><link rel="prefetch" href="/wiki/assets/js/43.69a0a51c.js"><link rel="prefetch" href="/wiki/assets/js/44.892f6327.js"><link rel="prefetch" href="/wiki/assets/js/45.ce6f0ee1.js"><link rel="prefetch" href="/wiki/assets/js/46.dcc656cd.js"><link rel="prefetch" href="/wiki/assets/js/5.5b3fd24d.js"><link rel="prefetch" href="/wiki/assets/js/6.3b848e60.js"><link rel="prefetch" href="/wiki/assets/js/7.1d469969.js"><link rel="prefetch" href="/wiki/assets/js/8.18290f0f.js"><link rel="prefetch" href="/wiki/assets/js/9.2bb47d5a.js">
    <link rel="stylesheet" href="/wiki/assets/css/0.styles.cf734400.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/wiki/" class="home-link router-link-active"><img src="/wiki/favicon.ico" alt="CS Wiki" class="logo"> <span class="site-name can-hide">CS Wiki</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/wiki/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/wiki/archives/" class="nav-link">
  归档
</a></div><div class="nav-item"><a href="/wiki/c/" class="nav-link">
  C
</a></div><div class="nav-item"><a href="/wiki/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          理论
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/wiki/data-structure/" class="nav-link">
  数据结构
</a></li><li class="dropdown-subitem"><a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  计算机网络
</a></li><li class="dropdown-subitem"><a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  计算机组成原理
</a></li><li class="dropdown-subitem"><a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  操作系统
</a></li><li class="dropdown-subitem"><a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  数据库
</a></li><li class="dropdown-subitem"><a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  编译原理
</a></li></ul></li><li class="dropdown-item"><h4>
          工具
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/wiki/tools/vim.html" class="nav-link">
  Vim
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/Makefile.html" class="nav-link">
  Makefile
</a></li><li class="dropdown-subitem"><a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  shell
</a></li><li class="dropdown-subitem"><a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  正则表达式
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/git.html" class="nav-link">
  git
</a></li><li class="dropdown-subitem"><a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  python
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/gdb.html" class="nav-link">
  gdb
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="嵌入式" class="dropdown-title"><span class="title">嵌入式</span> <span class="arrow down"></span></button> <button type="button" aria-label="嵌入式" class="mobile-dropdown-title"><span class="title">嵌入式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  x86汇编
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/sqlite3.html" class="nav-link">
  sqlite3
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/stm32/" class="nav-link">
  stm32
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/collections.html" class="nav-link">
  问题集
</a></li></ul></div></div><div class="nav-item"><a href="https://chunni98.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/wiki/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/wiki/archives/" class="nav-link">
  归档
</a></div><div class="nav-item"><a href="/wiki/c/" class="nav-link">
  C
</a></div><div class="nav-item"><a href="/wiki/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          理论
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/wiki/data-structure/" class="nav-link">
  数据结构
</a></li><li class="dropdown-subitem"><a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  计算机网络
</a></li><li class="dropdown-subitem"><a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  计算机组成原理
</a></li><li class="dropdown-subitem"><a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  操作系统
</a></li><li class="dropdown-subitem"><a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  数据库
</a></li><li class="dropdown-subitem"><a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  编译原理
</a></li></ul></li><li class="dropdown-item"><h4>
          工具
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/wiki/tools/vim.html" class="nav-link">
  Vim
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/Makefile.html" class="nav-link">
  Makefile
</a></li><li class="dropdown-subitem"><a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  shell
</a></li><li class="dropdown-subitem"><a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  正则表达式
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/git.html" class="nav-link">
  git
</a></li><li class="dropdown-subitem"><a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  python
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/gdb.html" class="nav-link">
  gdb
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="嵌入式" class="dropdown-title"><span class="title">嵌入式</span> <span class="arrow down"></span></button> <button type="button" aria-label="嵌入式" class="mobile-dropdown-title"><span class="title">嵌入式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wiki/Linux/unix-programing/.html#" class="nav-link">
  x86汇编
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/sqlite3.html" class="nav-link">
  sqlite3
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/stm32/" class="nav-link">
  stm32
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/collections.html" class="nav-link">
  问题集
</a></li></ul></div></div><div class="nav-item"><a href="https://chunni98.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/wiki/Linux/" aria-current="page" class="sidebar-link">Linux 笔记</a></li><li><a href="/wiki/Linux/learn-linux.html" class="sidebar-link">1 Linux 笔记</a></li><li><a href="/wiki/Linux/linux-collections.html" class="sidebar-link">2 Linux 问题集</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/wiki/Linux/unix-programing/" class="sidebar-heading clickable router-link-active open"><span>Unix 环境编程</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/wiki/Linux/unix-programing/unix-pro01.html" class="sidebar-link">01 文件 I/O</a></li><li><a href="/wiki/Linux/unix-programing/unix-pro02.html" aria-current="page" class="active sidebar-link">02 多进程编程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro02.html#_2-1-进程" class="sidebar-link">2.1  进程</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro02.html#_2-2-linux-下的进程管理" class="sidebar-link">2.2 Linux 下的进程管理</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro02.html#_2-3-内核空间和用户空间" class="sidebar-link">2.3 内核空间和用户空间</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro02.html#_2-4-命令置换" class="sidebar-link">2.4 命令置换</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro02.html#_2-5-exec-函数族" class="sidebar-link">2.5 exec 函数族</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro02.html#_2-6-ext4-文件系统" class="sidebar-link">2.6 ext4 文件系统</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro02.html#_2-7-文件锁" class="sidebar-link">2.7 文件锁</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro02.html#_2-8-进程的结束" class="sidebar-link">2.8 进程的结束</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro02.html#_2-9-守护进程" class="sidebar-link">2.9 守护进程</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro02.html#_2-10-进程和线程的选择与区别" class="sidebar-link">2.10 进程和线程的选择与区别</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro02.html#_2-11-dup-和-dup2" class="sidebar-link">2.11 dup() 和 dup2()</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro02.html#_2-12-linux-log" class="sidebar-link">2.12 Linux LOG</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro02.html#_2-13-linux-进程间通信" class="sidebar-link">2.13 Linux 进程间通信</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro02.html#_2-14-进程间通信方式的比较" class="sidebar-link">2.14 进程间通信方式的比较</a></li></ul></li><li><a href="/wiki/Linux/unix-programing/unix-pro03.html" class="sidebar-link">03 多线程编程</a></li><li><a href="/wiki/Linux/unix-programing/unix-pro04.html" class="sidebar-link">04 网络编程</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_2-1-进程"><a href="#_2-1-进程" class="header-anchor">#</a> 2.1  进程</h2> <h3 id="_2-1-1-进程的组成"><a href="#_2-1-1-进程的组成" class="header-anchor">#</a> 2.1.1 进程的组成</h3> <p>每个进程都有自己的 PCB，所有进程都有唯一的 PCB。操作系统依据PCB管理进程，操作系统利用 PCB 实现进程的动态和并发，PCB是进程存在的唯一标志。</p> <p>所有进程都是既运行于用户方式下，又运行于系统方式下。进程每次调用一个系统调用时，都要从用户方式切换到系统方式，并继续执行。</p> <p>进程的状态：</p> <table><thead><tr><th>标志</th> <th>状态</th></tr></thead> <tbody><tr><td><code>D</code></td> <td>不可中断的静止</td></tr> <tr><td><code>R</code></td> <td>正在执行中</td></tr> <tr><td><code>S</code></td> <td>阻塞状态</td></tr> <tr><td><code>T</code></td> <td>暂停执行</td></tr> <tr><td><code>Z</code></td> <td>不存在但是暂时无法消除</td></tr> <tr><td><code>W</code></td> <td>没有足够的内存分页可以分配</td></tr> <tr><td><code>&lt;</code></td> <td>高优先级的进程</td></tr> <tr><td><code>N</code></td> <td>低优先级的进程</td></tr> <tr><td><code>L</code></td> <td>有内存分页分配并所在内存中</td></tr> <tr><td><code>+</code></td> <td>前台进程</td></tr></tbody></table> <p><code>c-z</code> 暂停进程。</p> <p><code>c-c</code> 停止进程，可以被捕获。</p> <p><code>jobs -l</code> 查看后台进程。</p> <p><code>fg %num</code> 把后台进程调到前台。</p> <p><code>&amp;</code> 让进程在后台执行。</p> <h3 id="_2-1-2-linux-系统中的进程类型"><a href="#_2-1-2-linux-系统中的进程类型" class="header-anchor">#</a> 2.1.2 Linux 系统中的进程类型</h3> <p>（1）交互教程</p> <p>（2）批处理进程</p> <p>（3）守护进程</p> <h3 id="_2-1-3-进程的互斥"><a href="#_2-1-3-进程的互斥" class="header-anchor">#</a> 2.1.3 进程的互斥</h3> <p>（1）临界资源</p> <p>操作系统中一次只允许一个进程访问的资源。</p> <p>（2）进程互斥</p> <p>若干进程要使用某一个共享资源时，任何时候最多允许一个进程使用。任何时候最多允许一个进程使用，其他要使用该资源的进程必须等待，直到只用自愿者释放了该资源。</p> <p>（3）进程同步</p> <p>一组并发进程按一定的顺序执行的过程称为进程间的同步。具有同步关系的一组并发进程称为合作进程，合作进程间互相发送的信号称为消息或事件。</p> <p>（4）临界区</p> <p>进程中访问连接资源的那段代码称为临界区。为实现对临界资源的互斥访问，应保证诸进程互斥地进入各自的临界区。</p> <h3 id="_2-1-4-进程的调度"><a href="#_2-1-4-进程的调度" class="header-anchor">#</a> 2.1.4 进程的调度</h3> <p>（1）抢占式调度</p> <p>（2）非抢占式调度</p> <p>（3）先来先服务调度算法</p> <p>（4）短进程优先调度算法</p> <p>（5）高优先级优先调度算法</p> <p>（6）时间片轮转法</p> <h3 id="_2-1-5-死锁"><a href="#_2-1-5-死锁" class="header-anchor">#</a> 2.1.5 死锁</h3> <p>多个进程因竞争资源而形成一种僵局，若无外力作用，这些进程将永远不能向前推进。</p> <ul><li>互斥条件，临界资源是独占资源，进程应互斥且排他的使用这些资源。</li> <li>占有和等待条件，进程在请求资源得不到满足而等待时，不释放已占有资源。</li> <li>不剥夺条件，又称不可抢占，已获资源只能由进程自愿释放，不允许被其他进程剥夺。</li> <li>循环等待条件，又称环路条件，存在循环等待链，其中，每个进程都在等待链中等待下一个进程所持有的资源，造成这组进程处于永远等待状态。</li></ul> <p>各种死锁防止方法能够防止发生死锁，但必然会降低系统并发性，导致低效的资源利用率。</p> <p>避免死锁：银行家算法</p> <p>死锁检测和解除</p> <h3 id="_2-1-6-进程的模式"><a href="#_2-1-6-进程的模式" class="header-anchor">#</a> 2.1.6 进程的模式</h3> <p>进程的执行模式分为用户模式和内核模式。</p> <p>用户模式通过系统调用进入内核模式。</p> <h3 id="_2-1-7-进程的创建"><a href="#_2-1-7-进程的创建" class="header-anchor">#</a> 2.1.7 进程的创建</h3> <p>函数原型：<code>pid_t fork(void);</code></p> <p>调用fork后，子进程获得父进程数据段、堆和栈的副本。</p> <p>缓冲区是在堆上的，所以子进程也获得了父进程的缓冲区。</p> <p>fork确实创建可一个子进程并完全复制父进程，但是子进程是从fork后面的那个指令开始执行。</p> <p>子进程是父进程的副本，它将获得父进程数据空间、堆、栈等资源的副本。</p> <p>父子进程间共享的存储空间只有代码段。</p> <p>fork调用的一个奇妙之处就是它仅仅被调用一次，却能够返回两次，它可能有三种不同的返回值：</p> <ul><li>在父进程中，fork返回新创建子进程的进程ID；</li> <li>在子进程中，fork返回 0。
如果出现错误，fork返回一个负值。</li></ul> <p>fork 的执行过程：</p> <ul><li>申请PID</li> <li>申请PCB结构</li> <li>复制父进程的PCB</li> <li>将子进程的运行状态设置为不可执行的</li> <li>将子进程中的某些属性清零，某些保留，某些修改</li> <li>复制父进程的页（用到了写时拷贝技术）</li></ul> <p><strong>vfork()</strong></p> <p>vfork也创建新进程，但它不产生父进程的副本。它通过允许父子进程可访问相同物理内存从而伪装了对进程地址空间的真实拷贝，当子进程需要改变内存中数据时才拷贝父进程。这就是著名的“写操作时拷贝(copy-on-write)技术</p> <p>1）fork()： 父子进程的执行次序不确定。</p> <p>vfork()：保证子进程先运行,在它调用 exec（进程替换） 或 exit（退出进程）之后父进程才可能被调度运行。</p> <p>2）fork()： 子进程拷贝父进程的地址空间，子进程是父进程的一个复制品。</p> <p>vfork()：子进程共享父进程的地址空间（准确来说，在调用 exec（进程替换） 或 exit（退出进程） 之前与父进程数据是共享的）。</p> <p>写时拷贝技术： 父子进程在初始阶段共享所有的数据（全局、 栈区、 堆区、 代码）， 内核会将所有的区域设置为只读。 当父子进程中任意一个进程试图修改其中的数据时， 内核才会将要修改的数据所在的区域（页） 拷贝一份。</p> <h2 id="_2-2-linux-下的进程管理"><a href="#_2-2-linux-下的进程管理" class="header-anchor">#</a> 2.2 Linux 下的进程管理</h2> <p>（1）启动进程</p> <ul><li>手工启动（<code>bg</code>后台运行，<code>fg</code>前台运行）</li> <li>调度启动（<code>at</code>在指定时刻执行相关进程，<code>corn</code>周期性执行相关进程）</li></ul> <p>TODO: 进程组、会话</p> <h2 id="_2-3-内核空间和用户空间"><a href="#_2-3-内核空间和用户空间" class="header-anchor">#</a> 2.3 内核空间和用户空间</h2> <p>以32 位 Linux 操作系统为例，将最高的1G字节（从虚拟地址0xC0000000到0xFFFFFFFF），供内核使用，称为内核空间，而将较低的3G字节（从虚拟地址0x00000000到0xBFFFFFFF），供各个进程使用，称为用户空间。</p> <p>用户态的程序不能随意操作内核地址空间，这样对操作系统具有一定的安全保护作用。</p> <p>当进程/线程运行在内核空间时就处于内核态，而进程/线程运行在用户空间时则处于用户态。</p> <p>当一个任务（进程）执行系统调用而陷入内核代码中执行时，称进程处于内核运行态（内核态），除了系统调用可以实现用户态到内核态的切换，还有软中断和硬中断。软中断是指进程发生了异常事件；硬中断就有很多种，例如时钟周期、IO等。</p> <p>在内核态下，进程运行在内核地址空间中，此时 CPU 可以执行任何指令。运行的代码也不受任何的限制，可以自由地访问任何有效地址，也可以直接进行端口的访问。</p> <p>在用户态下，进程运行在用户地址空间中，被执行的代码要受到 CPU 的很多检查，比如：进程只能访问映射其地址空间的页表项中规定的在用户态下可访问页面的虚拟地址。</p> <p><img src="/linux/linux%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84.png" alt=""></p> <p>在用户空间是无法实现进程通信的，但是在内核系统空间是可以的，因为操作系统管理着所有的进程。</p> <h2 id="_2-4-命令置换"><a href="#_2-4-命令置换" class="header-anchor">#</a> 2.4 命令置换</h2> <p>将一个命令的输出作为另一个命令的参数。</p> <p>格式如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>command1 `command2`

如:
$ ls `pwd`

将 pwd 命令的结果作为 ls 命令的参数。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_2-5-exec-函数族"><a href="#_2-5-exec-函数族" class="header-anchor">#</a> 2.5 exec 函数族</h2> <p>exec函数族提供了一种在进程中启动另一个程序执行的方法。它可以根据指定的文件名或目录名找到可执行文件，</p> <p>并用它来取代原调用进程的数据段、代码段和堆栈段。在执行完之后，原调用进程的内容除了进程号外，其他全部都被替换了。</p> <p>可执行文件既可以是二进制文件，也可以是任何Linux下可执行的脚本文件。</p> <p>当进程调用exec函数时，该进程被完全替换为新程序。因为调用exec函数并不创建新进程，所以前后进程的ID并没有改变。</p> <p>exec 函数族提供了六种在进程中启动另一个程序的方法。exec 函数族的作用是根据指定的文件名或目录名找到可执行文件，并用它来取代调用进程的内容。</p> <h3 id="_2-5-1-使用场景"><a href="#_2-5-1-使用场景" class="header-anchor">#</a> 2.5.1 使用场景</h3> <p>当进程认为自己不能再为系统和用户做出任何贡献了时就可以调用exec函数，让自己执行新的程序</p> <p>如果某个进程想同时执行另一个程序，它就可以调用fork函数创建子进程，然后在子进程中调用任何一个exec函数。这样看起来就好像通过执行应用程序而产生了一个新进程一样</p> <h3 id="_2-5-2-语法"><a href="#_2-5-2-语法" class="header-anchor">#</a> 2.5.2 语法</h3> <p><strong>函数原型</strong></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">extern</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>environ<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">execl</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">execle</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">execv</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">execvp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>execve</code> 是系统调用。</p> <p>l(list)：参数地址列表，以空指针结尾。</p> <p>v(vector)：存有各参数地址的指针数组的地址。</p> <p>p(path)：按 PATH 环境变量指定的目录搜索可执行文件。</p> <p>e(environment)：存有环境变量字符串地址的指针数组的地址。</p> <p><strong>返回值</strong></p> <p>exec函数族的函数执行成功后不会返回，调用失败时，会设置errno并返回-1，然后从原程序的调用点接着往下执行。</p> <p><strong>参数说明</strong></p> <ul><li>path：可执行文件的路径名字</li> <li>arg：可执行程序所带的参数，第一个参数为可执行文件名字，没有带路径且arg必须以NULL结束</li> <li>file：如果参数file中包含/，则就将其视为路径名，否则就按 PATH环境变量，在它所指定的各目录中搜寻可执行文件。</li></ul> <p>exec族函数参数极难记忆和分辨，函数名中的字符会给我们一些帮助：</p> <ul><li>l : 使用参数列表</li> <li>p：使用文件名，并从PATH环境进行寻找可执行文件</li> <li>v：应先构造一个指向各参数的指针数组，然后将该数组的地址作为这些函数的参数。</li> <li>e：多了envp[]数组，使用新的环境变量代替调用进程的环境变量</li></ul> <p>一、带l的一类exac函数（l表示list），包括execl、execlp、execle，要求将新程序的每个命令行参数都说明为 一个单独的参数。这种参数表以空指针结尾。</p> <p>例：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;before exec\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">/* /bin/ls：外部程序，这里是/bin目录的 ls 可执行程序，必须带上路径（相对或绝对）
	   ls：没有意义，如果需要给这个外部程序传参，这里必须要写上字符串，至于字符串内容任意
	   -a，-l，-h：给外部程序 ls 传的参数
	   NULL：这个必须写上，代表给外部程序 ls 传参结束
	*/</span>
	<span class="token function">execl</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/ls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-l&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-h&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// 如果 execl() 执行成功，下面执行不到，因为当前进程已经被执行的 ls 替换了</span>
	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;after exec\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>二、带p的一类exac函数，包括execlp、execvp、execvpe，如果参数file中包含/，则就将其视为路径名，否则就按 PATH环境变量，</p> <p>在它所指定的各目录中搜寻可执行文件。举个例子，<code>PATH=/bin:/usr/bin</code></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//文件execlp.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
 <span class="token comment">// 第一个参数 &quot;ls&quot;，没有带路径名，在环境变量 PATH 里寻找这个可执行程序</span>
 <span class="token comment">// 其它参数用法和 execl() 一样</span>
	<span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-l&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-h&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">/*
	char *arg[]={&quot;ls&quot;, &quot;-a&quot;, &quot;-l&quot;, &quot;-h&quot;, NULL};
	execvp(&quot;ls&quot;, arg);
	*/</span>

	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execlp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>三、带v不带l的一类exac函数，包括execv、execvp、execve，应先构造一个指向各参数的指针数组，然后将该数组的地址作为这些函数的参数。</p> <p>如 <code>char *arg[]</code> 这种形式，且arg最后一个元素必须是NULL，例如 <code>char *arg[] = {“ls”,”-l”,NULL}</code>;</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
 <span class="token comment">// execv() 和 execl() 的用法基本是一样的，无非将列表传参，改为用指针数组</span>
 <span class="token comment">// execl(&quot;/bin/ls&quot;, &quot;ls&quot;, &quot;-a&quot;, &quot;-l&quot;, &quot;-h&quot;, NULL);</span>

 <span class="token comment">/* 指针数组
	   ls：没有意义，如果需要给这个外部程序传参，这里必须要写上字符串，至于字符串内容任意
	   -a，-l，-h：给外部程序 ls 传的参数
	   NULL：这个必须写上，代表给外部程序 ls 传参结束
	*/</span>
 <span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-l&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-h&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

 <span class="token comment">// /bin/ls：外部程序，这里是/bin目录的 ls 可执行程序，必须带上路径（相对或绝对）</span>
 <span class="token comment">// arg： 上面定义的指针数组地址</span>
	<span class="token function">execv</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/ls&quot;</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
 <span class="token comment">// 第一个参数 &quot;ls&quot;，没有带路径名，在环境变量 PATH 里寻找这个可执行程序</span>
 <span class="token comment">// 其它参数用法和 execl() 一样</span>
	<span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-l&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-h&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">/*
	char *arg[]={&quot;ls&quot;, &quot;-a&quot;, &quot;-l&quot;, &quot;-h&quot;, NULL};
	execvp(&quot;ls&quot;, arg);
	*/</span>

	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execlp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>四、带e的一类exac函数，包括execle、execvpe，可以传递一个指向环境字符串指针数组的指针。</p> <p>参数例如 <code>char *env_init[] = {“AA=aa”,”BB=bb”,NULL}</code>; 带e表示该函数取envp[]数组，而不使用当前环境。</p> <p>execle() 和 execve() 改变的是 exec 启动的程序的环境变量（只会改变进程的环境变量，不会影响系统的环境变量）</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// exec.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span> <span class="token comment">// getenv()</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
 <span class="token comment">// getenv() 获取指定环境变量的值</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;before exec：USER=%s, HOME=%s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;USER&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;HOME&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// 指针数据</span>
 <span class="token keyword">char</span> <span class="token operator">*</span>env<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;USER=MIKE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;HOME=/tmp&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
 <span class="token comment">/* ./mike：外部程序，当前路径的 mike 程序，通过 gcc mike.c -o mike 编译
		mike：这里没有意义
		NULL：给 mike 程序传参结束
		env：改变 mike 程序的环境变量，正确来说，让 mike 程序只保留 env 的环境变量
	 */</span>
	<span class="token function">execle</span><span class="token punctuation">(</span><span class="token string">&quot;./mike&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mike&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">/*
	char *arg[]={&quot;mike&quot;, NULL};
	execve(&quot;./mike&quot;, arg, env);
	*/</span>

	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;execle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// 外部程序 mike.c</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\nin the mike fun, after exec: \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;USER=%s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;USER&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;HOME=%s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;HOME&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h2 id="_2-6-ext4-文件系统"><a href="#_2-6-ext4-文件系统" class="header-anchor">#</a> 2.6 ext4 文件系统</h2> <h3 id="_2-6-1-特色"><a href="#_2-6-1-特色" class="header-anchor">#</a> 2.6.1 特色</h3> <p><strong>（1）大型文件系统</strong></p> <p>ext4文件系统可支持最高1 Exbibyte的分区与最大16 Tebibyte的文件。</p> <p><strong>（2）Extent文件存储方式</strong></p> <p>ext4引进了Extent文件存储方式，以取代ext2/3使用的block mapping方式。Extent指的是一连串的连续实体block，这种方式可以增加大型文件的效率并减少分裂文件。ext4支持的单一Extent，在单一block为4KB的系统中最高可达128MB。单一inode中可存储4笔Extent；超过四笔的Extent会以Htree方式被索引。</p> <p><strong>（3）向下兼容</strong></p> <p>ext4向下兼容于ext3与ext2，因此可以将ext3和ext2的文件系统挂载为ext4分区。由于某些ext4的新功能可以直接运用在ext3和ext2上，直接挂载即可提升少许性能。
ext3文件系统可以部分向上兼容于ext4（也就是说ext4文件系统可以被挂载为ext3分区）。然而若是使用到Extent技术的ext4将无法被挂载为ext3。</p> <p><strong>（4）预留空间</strong></p> <p>ext4允许对一文件预先保留磁盘空间。目前大多数文件系统做到这点的方式是直接产生一个填满0的文件；ext4和XFS可以使用Linux核心中的一个新的系统调用“fallocate()”获取足够的预留空间。</p> <p><strong>（5）延迟获取空间</strong></p> <p>ext4使用一种称为allocate-on-flush的方式，可以在资料将被写入磁盘（sync）前才开始获取空间；大多数文件系统会在之前便获取需要的空间。这种方式可以增加性能并减少文件分散程度。</p> <p><strong>（6）突破 32000 子目录限制，最多可达 64000 子目录</strong></p> <p>ext3的一个目录下最多只能有32000个子目录。ext4的子目录最高可达64000，且使用“dir_nlink”功能后可以达到更高（虽然父目录的link count会停止增加）。为了避免性能受到大量目录的影响，ext4默认开启Htree（一种特殊的B树）索引功能。该功能已经实现于Linux核心2.6.23版。</p> <p><strong>（7）日志校验和</strong></p> <p>Ext4使用校验和特性来提高文件系统可靠性，因为日志是磁盘上被读取最频繁的部分之一。这个特性还有一个好处就是可以安全地避免日志处理时磁盘I/O的等待，而稍微提高一些性能。日志校验和的技术源于威斯康辛大学的一篇名为IRON File Systems的研究论文（见第六节transaction checksums校验和处理）</p> <p><strong>（8）在线磁盘整理</strong></p> <p>对于在线磁盘整理工具有许多草案，但是这些草案都没有被包含在主流的内核当中。即使Ext4包含有许多避免磁盘碎片的技术，但是磁盘碎片还是难免会在一个长时间使用过的文件系统中存在。Ext4将会有一个具有磁盘整理功能的工具。</p> <p><strong>（9）快速文件系统检查</strong></p> <p>Ext4将未使用的区块标记在inode当中，这样可以使诸如e2fsck之类的工具在磁盘检查时将这些区块完全跳过，而节约大量的文件系统检查的时间。这个特性已经在2.6.24版本的Linux内核中实现。</p> <h2 id="_2-7-文件锁"><a href="#_2-7-文件锁" class="header-anchor">#</a> 2.7 文件锁</h2> <h3 id="_2-7-1-对整个文件锁定"><a href="#_2-7-1-对整个文件锁定" class="header-anchor">#</a> 2.7.1 对整个文件锁定</h3> <p>flock - apply or remove an advisory lock on an open file</p> <p><code>int flock(int fd, int operation);</code></p> <p>id 是需要加锁的文件的描述符，operation 可以是下列值：</p> <ul><li><code>LOCK_SH</code> 共享锁，多个进程可以同时拥有对文件的共享锁。</li> <li><code>LOCK_EX</code> 互斥锁，一个文件只能上一把互斥锁。</li> <li><code>LOCK_UN</code> 解锁操作。</li> <li><code>LOCK_NB</code> 如果进程不能获取指定的锁，函数将不阻塞，缺省时，进程将睡眠等待。</li></ul> <p>共享锁用于不更改或不更新数据的操作（只读操作）</p> <h2 id="_2-8-进程的结束"><a href="#_2-8-进程的结束" class="header-anchor">#</a> 2.8 进程的结束</h2> <h3 id="_2-8-1-exit-和-exit"><a href="#_2-8-1-exit-和-exit" class="header-anchor">#</a> 2.8.1 exit 和 _exit</h3> <p><code>void exit(int status);</code></p> <p><code>void _exit(int status)</code></p> <p>status 是一个整型的参数，可以利用这个参数传递进程结束时的状态。通常用 0 表示正常结束，其他数值表示出现了错误，进程非正常结束。</p> <p>再实际编程时，可以用 wait 系统调用接受子进程的返回值，进行相应的处理。</p> <p><code>_exit()</code> 函数作用最简单，直接使进程终止运行，清除使用的内存空间，并销毁数据结构。</p> <p><code>exit()</code> 函数则在这些基础上作了一些包装，推出前检查文件的打开情况，把文件缓冲区中的内容写回文件，清理 I/O 缓冲。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Using exit...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;This is the end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span>root@farsight<span class="token punctuation">]</span># <span class="token punctuation">.</span><span class="token operator">/</span>exit_test2
Using exit<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> This is the end
<span class="token punctuation">[</span>root@farsight<span class="token punctuation">]</span>#

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Using _exit...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;This is the end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token punctuation">[</span>root@farsight<span class="token punctuation">]</span># <span class="token punctuation">.</span><span class="token operator">/</span>_exit
Using _exit<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">[</span>root@farsight<span class="token punctuation">]</span>#
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_2-8-2-wait-waitpid"><a href="#_2-8-2-wait-waitpid" class="header-anchor">#</a> 2.8.2 wait/waitpid</h3> <p><strong>（1）wait函数</strong></p> <p>调用该函数使进程阻塞，直到任一个子进程结束或者是该进程接收到了一个信号为止。如果该进程没有子进程或者其子进程已经结束，wait函数会立即返回。</p> <p>waitpid函数</p> <p>功能和wait函数类似。可以指定等待某个子进程结束以及等待的方式（阻塞或非阻塞）</p> <p>头文件</p> <p><code>#include &lt;sys/types.h&gt;</code> <code>#include &lt;sys/wait.h&gt;</code></p> <p>函数原型： <code>pid_t wait(int *status)</code></p> <p>参数：</p> <p>status 是一个整型指针，指向的对象用来保存子进程推出时的状态。</p> <ul><li>status 若为空，则表示忽略子进程退出时的状态。</li> <li>status 不为空，则表示保存子进程退出时的所有状态。</li></ul> <p>此为可以用一些宏检测：</p> <table><thead><tr><th style="text-align:center;">状态</th> <th style="text-align:center;">判断宏</th> <th style="text-align:center;">取值宏</th></tr></thead> <tbody><tr><td style="text-align:center;">进程正常结束</td> <td style="text-align:center;"><code>WIFEXITED(status)</code></td> <td style="text-align:center;"><code>WEXITSTATUS(status)</code></td></tr> <tr><td style="text-align:center;">进程正常结束</td> <td style="text-align:center;"><code>WIFSIGNALED(status)</code></td> <td style="text-align:center;"><code>WTERMSIG(status)</code></td></tr> <tr><td style="text-align:center;">进程正常结束</td> <td style="text-align:center;"><code>WIFSTOPPED(status)</code></td> <td style="text-align:center;"><code>WSTOPSIG(status)</code></td></tr></tbody></table> <p>WTERMSIG宏测试被执行后，若成功返回被终止的子进程的信号值。返回的信号值被定义在 sys/signals.h头文件中。</p> <p>返回值：成功返回结束子进程的 pid 码。</p> <p><strong>（2）waitpid 函数</strong></p> <p>一个进程在调用exit命令结束自己的生命的时候，其实它并没有真正的被销毁，而是留下一个称为僵尸进程(Zombie)的数据结构</p> <p>(系统调用exit，它的作用是使进程退出，但也仅仅限于将一个正常的进程变成一个僵尸进程，并不能将其完全销毁)。</p> <p>函数原型：<code>pid_t waitpid(pid_t pid, int *status, int options);</code></p> <p>函数参数：</p> <ul><li><code>pid</code> <ul><li><code>&gt;0</code> 只等待进程 ID 等于 pid 的子进程，只要指定的子进程还没有结束，waitpid 就会一直等下去。</li> <li><code>=-1</code>，等待任何一个子进程退出，和 <code>wait</code> 作用一样。</li> <li><code>=0</code> 等待组 ID 等于调用进程的组 ID 的任一子进程。</li> <li><code>&lt; -1</code> 等待其组 ID 等于 pid 的绝对值的任一子进程。</li></ul></li> <li><code>status</code> ，同 wait</li> <li><code>options</code> <ul><li><code>WNOHANG</code> 若由 pid 指定的子进程并不立即可用，则 waitpid 不阻塞，此时返回值为 0。</li> <li><code>WUNTRACED</code> 若某实现支持作业控制，则由 pid 指定的任意子进程状态已暂停，且其状态子暂停依赖还未报告过，则返回其状态。</li> <li><code>0</code> 阻塞父进程，等待子进程退出。</li> <li>判断子进程结束原因
<ul><li><code>WIFEXITED</code></li> <li><code>WIFSIGNALED</code></li> <li><code>WIFSTOPPED</code></li> <li><code>WSTOPSIG</code></li></ul></li></ul></li></ul> <p>进程组组号，等于父进程 pid</p> <p>函数返回值：</p> <ul><li>正常：结束的子进程的进程号。</li> <li>使用选项 WNOHANG 且没有子进程结束时：0</li> <li>调用出错 -1，设置错误码</li></ul> <h2 id="_2-9-守护进程"><a href="#_2-9-守护进程" class="header-anchor">#</a> 2.9 守护进程</h2> <h3 id="_2-9-1-守护进程和后台进程的区别"><a href="#_2-9-1-守护进程和后台进程的区别" class="header-anchor">#</a> 2.9.1 守护进程和后台进程的区别</h3> <p><strong>守护进程与后台进程的区别</strong></p> <ul><li>守护进程已经完全脱离终端控制台了，而后台程序并未完全脱离终端，在终端未关闭前还是会往终端输出结果</li> <li>守护进程在关闭终端控制台时不会受影响，而后台程序会随用户退出而停止，需要在以 <code>nohup command &amp;</code> 格式运行才能避免影响</li></ul> <p><strong>实现守护进程的方式</strong></p> <p>要实现守护进程，一种方法是按守护进程的规则去编程，比较麻烦；另一种方法是仍然用普通方法编程，然后用nohup命令启动程序：</p> <p><code>nohup &lt;程序名&gt; &amp;</code></p> <p>用nohup启动的进程，当控制台logout后，进程仍然继续运行，起到守护进程的作用（虽然它不是严格意义上的守护进程）。</p> <p>默认情况下，使用nohup命令后，原程序的的标准输出被自动改向到当前目录下的nohup.out文件，起到了log的作用，实现了完整的守护进程功能。</p> <p><strong>为什么脱离终端？</strong></p> <p>守护进程是个特殊的孤儿进程，这种进程脱离终端，为什么要脱离终端呢？
之所以脱离于终端是为了避免进程被任何终端所产生的信息所打断，
其在执行过程中的信息也不在任何终端上显示。由于在 Linux 中，
每一个系统与用户进行交流的界面称为终端，每一个从此终端开始运行的进程都会依附于这个终端，
这个终端就称为这些进程的控制终端，当控制终端被关闭时，相应的进程都会自动关闭。</p> <h3 id="_2-9-2-介绍"><a href="#_2-9-2-介绍" class="header-anchor">#</a> 2.9.2 介绍</h3> <p>Daemon 进程，生存期较长的进程，通常独立于控制终端并且周期性的执行某种任务或等待处理某些发生的事件，是特殊的孤儿进程。</p> <p>守护进程常常在系统引导装入时启动，在系统关闭时终止。</p> <p>在Linux中，每一个系统与用户进行交流的界面称为终端，每一个从此终端开始运行的进程都会依附于这个终端，这个终端就称为这些进程的控制终端，当控制终端被关闭时，相应的进程都会被自动关闭。</p> <p>守护进程能够突破这种限制，它从被执行开始运转，直到整个系统关闭才会退出。如果想让某个进程不因为<strong>用户或终端</strong>或其他的变化而受到影响，就必须把这个进程变成一个守护进程。</p> <p><strong>守护进程的一些特点</strong></p> <ul><li>守护进程基本上都是以超级用户启动（ UID 为 0 ）</li> <li>没有控制终端（ TTY 为 ？）</li> <li>终端进程组 ID 为 -1 （ TPGID 表示终端进程组 ID）</li></ul> <p>一般情况下，守护进程可以通过以下方式启动：</p> <ul><li>在系统启动时由启动脚本启动，这些启动脚本通常放在 <code>/etc/rc.d</code> 目录下；</li> <li>利用 inetd 超级服务器启动，如 telnet 等；</li> <li>由 cron 定时启动以及在终端用 nohup 启动的进程也是守护进程。</li></ul> <h3 id="_2-9-3-进程组和会话期"><a href="#_2-9-3-进程组和会话期" class="header-anchor">#</a> 2.9.3 进程组和会话期</h3> <p><strong>（1）进程组</strong></p> <p>进程组是一个或多个进程的集合。进程组由进程组 ID 来唯一标识，除了进程号（PID）之外，进程组 ID 也是一个进程的必备属性之一。</p> <p>每个进程组都有一个组长进程，<strong>组长进程的进程号</strong>等于进程组 ID。</p> <p><strong>（2）会话期</strong></p> <p>会话组是一个或多个进程组的集合。</p> <p>通常一个会话开始于用户登录，终止于用户退出，在此期间该用户运行的所有进程都属于这个会话期。</p> <p><strong>（3）setsid()</strong></p> <p><code>setsid()</code> 创建一个新会话，并担任该会话组的组长，调用setsid函数的目的：让进程摆脱原会话，原进程组，原终端的控制。如果，<strong>调用setsid的进程不是一个进程组的组长</strong>，此函数创建一个新的会话期。</p> <p>setsid 的调用者不能是 group leader。</p> <ul><li>摆脱原会话的控制。</li> <li>摆脱原进程组的控制。</li> <li>摆脱原控制终端的控制。</li></ul> <h3 id="_2-9-4-步骤"><a href="#_2-9-4-步骤" class="header-anchor">#</a> 2.9.4 步骤</h3> <p><strong>（1）创建子进程，结束父进程</strong></p> <p>子进程变成孤儿进程，变成 init 进程的子进程。形式上脱离终端控制，在后台工作。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 父进程退出</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>（2）setsid，子进程成为新会话过程的leader 进程</strong></p> <p>子进程全盘拷贝了父进程的会话期、进程组、控制终端，父进程退出了，但会话期、进程组、控制终端没有改变。</p> <p>子进程继续运行，父进程退出的时候，将会产生 SIGHUP 信号。</p> <p>setsid() 调用成功后，进程成为新的会话组长和新的进程组长，并与原来的登录会话和进程组脱离。由于会话过程对控制终端的独占性，进程同时与控制终端脱离。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在 sid == pid == pgid，现在收不到终端的信号。</p> <p><strong>（3）防止进程重新打开控制终端</strong></p> <p>现在进程成为无终端的会话组长，但是如果再打开一个终端，将会成为它的控制终端。</p> <p>因为进程打开一个控制终端的前台条件是该进程必须是会话组长。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// 父进程退出</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>结束子进程，第二子进程不再是会话组长。pid != sid，无法打开新的控制终端。</p> <p><strong>（4）关闭打开的文件描述符</strong></p> <p>进程从创建它的父进程那里继承了打开的文件描述符。如不关闭，将会浪费系统资源，造成进程所在的文件系统无法卸下以及引起无法预料的错误。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">sysconf</span><span class="token punctuation">(</span>_SC_OPEN_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">close</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>（5）更改工作目录</strong></p> <p>当进程产生错误的时候，将错误信息记录在当前目录的core文件，守护进程的特点一般会一直会打开当前目录。 解决方法，找一个不可能被卸载的目录。</p> <p>使用fork创建的子进程继承了父进程的当前工作目录。由于在进程运行过程中，当前目录所在的文件系统是不能卸载的，这对以后的使用会造成诸多的麻烦(比如进入单用户模式)。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>（6）消除 umask 的影响</strong></p> <p>进程从创建它的父进程那里继承了文件创建掩码。它可能修改守护进程所创建的文件的存取权限。为防止这一点，将文件创建掩码清除：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>（7）重新定位 I/O 描述符</strong></p> <p>将标准输入、标准输出、标准错误重定向到 <code>/dev/null</code>。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;/dev/null&quot;</span><span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">dup</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">dup</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_2-10-进程和线程的选择与区别"><a href="#_2-10-进程和线程的选择与区别" class="header-anchor">#</a> 2.10 进程和线程的选择与区别</h2> <p>进程是资源分配的最小单位，线程是CPU调度的最小单位。</p> <table><thead><tr><th style="text-align:center;">对比维度</th> <th style="text-align:center;">多进程</th> <th style="text-align:center;">多线程</th> <th style="text-align:center;">总结</th></tr></thead> <tbody><tr><td style="text-align:center;">数据共享、同步</td> <td style="text-align:center;">数据共享复杂，需要用 IPC，数据是分开的，同步简单</td> <td style="text-align:center;">共享进程数据，数据共享简单，但是同步复杂</td> <td style="text-align:center;">各有优势</td></tr> <tr><td style="text-align:center;">内存、CPU</td> <td style="text-align:center;">占用内存多，切换复杂，CPU利用率低</td> <td style="text-align:center;">占用内存少，切换简单，CPU利用率高</td> <td style="text-align:center;">线程占优</td></tr> <tr><td style="text-align:center;">创建销毁、切换</td> <td style="text-align:center;">创建销毁、切换复杂、速度慢</td> <td style="text-align:center;">创建销毁、切换简单，速度很快</td> <td style="text-align:center;">线程占优</td></tr> <tr><td style="text-align:center;">编程、调试</td> <td style="text-align:center;">编程简单，调试简单</td> <td style="text-align:center;">编程复杂，调试复杂</td> <td style="text-align:center;">进程占优</td></tr> <tr><td style="text-align:center;">可靠性</td> <td style="text-align:center;">进程间不会互相影响</td> <td style="text-align:center;">一个线程挂掉将会导致整个进程挂掉</td> <td style="text-align:center;">进程占优</td></tr> <tr><td style="text-align:center;">分布式</td> <td style="text-align:center;">适用于多核、多机分布式，扩展多机比较简单</td> <td style="text-align:center;">适用于多核分布式</td> <td style="text-align:center;">进程占优</td></tr></tbody></table> <p><strong>（1）需要频繁创建销毁的优先用线程</strong></p> <p>如 Web 服务器，来一个连接建立一个线程，断了就销毁线程。</p> <p><strong>（2）需要进行大量计算的优先用线程</strong></p> <p>如图像处理、算法处理。</p> <p><strong>（3）强相关的处理用线程，弱相关的处理用进程</strong></p> <p>一般的 Server 需要完成如下任务：消息收发、消息处理。“消息收发”和“消息处理”就是弱相关的任务，
而“消息处理”里面可能又分为“消息解码”、“业务处理”，这两个任务相对来说相关性就要强多了。
因此“消息收发”和“消息处理”可以分进程设计，“消息解码”、“业务处理”可以分线程设计。</p> <h2 id="_2-11-dup-和-dup2"><a href="#_2-11-dup-和-dup2" class="header-anchor">#</a> 2.11 dup() 和 dup2()</h2> <p><strong>dup()</strong></p> <p>函数原型：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">dup</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>打开一个新的最小文件描述符，指向和 oldfd 同一个文件，共享文件偏移量和文件状态。</p> <p>失败返回 -1。</p> <p><strong>dup2()</strong></p> <p>函数原型：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">dup2</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">,</span> <span class="token keyword">int</span> newfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>dup2 把指定的 newfd 也指向 oldfd 指向的文件，也就是说，执行完dup2之后，有newfd和oldfd同时指向同一个文件，共享文件偏移量和文件状态。</p> <h2 id="_2-12-linux-log"><a href="#_2-12-linux-log" class="header-anchor">#</a> 2.12 Linux LOG</h2> <h3 id="_2-12-1-syslog"><a href="#_2-12-1-syslog" class="header-anchor">#</a> 2.12.1 syslog</h3> <p>守护进程的标准终端已定位到空设备上，使用 syslogd 来记录守护进程的信息。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">openlog</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> LOG_PID<span class="token punctuation">,</span>facility<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token function">syslog</span><span class="token punctuation">(</span>LOG_CRIT<span class="token punctuation">,</span><span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_2-12-2-用户空间的守护进程-klogd"><a href="#_2-12-2-用户空间的守护进程-klogd" class="header-anchor">#</a> 2.12.2 用户空间的守护进程 klogd</h3> <p>用来从缓冲区获取内核消息。</p> <p>只有日记级别小于console_loglevel，消息才能显示出来，console_loglevel的值可以通过sys_syslogd系统调用进行修改</p> <p>载入klogd时，可以使用-c标志改变终端的记录等级</p> <p>运行klogd后，消息将追加到/var/log/messages</p> <p>没有运行klogd，消息不会传递到用户空间，此时可以查看/proc/kmsg文件。</p> <h3 id="_2-12-3-syslogd-进程"><a href="#_2-12-3-syslogd-进程" class="header-anchor">#</a> 2.12.3 syslogd 进程</h3> <p>保存klogd进程获取的内核消息到系统日志文件中默认的文件是/var/log/messages</p> <p>可通过/etc/syslog.conf文件重新配置。</p> <p>如果没有运行klogd进程，数据将保留在循环缓冲区中，直到某个进程读取和缓冲区溢出为止。</p> <p>调试信息数据流传递流程图:</p> <p><img src="/linux/%E8%B0%83%E8%AF%95%E4%BF%A1%E6%81%AF%E6%95%B0%E6%8D%AE%E6%B5%81%E4%BC%A0%E9%80%92%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt=""></p> <h3 id="_2-12-4-syslog"><a href="#_2-12-4-syslog" class="header-anchor">#</a> 2.12.4 syslog</h3> <p><strong>函数原型</strong></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;syslog.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">openlog</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ident<span class="token punctuation">,</span> <span class="token keyword">int</span> option<span class="token punctuation">,</span> <span class="token keyword">int</span> facility<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ident：字符串，它将添加在信息 message 前面</span>
<span class="token comment">// facility：指明应用进程的的类型</span>
<span class="token comment">//		LOG_KERN 操作系统核心</span>
<span class="token comment">//		LOG_USER 任何用户进程，普通的应用程序</span>
<span class="token comment">// 		LOG_MAIL 电子邮件系统</span>
<span class="token comment">// 		LOG_DAEMON 守护进程</span>
<span class="token comment">// 		LOG_AUTH 授权和鉴别系统</span>
<span class="token comment">// 		LOG_LPR 打印机缓冲系统</span>
<span class="token comment">// 		LOG_RPC RPC 和 NFS 系统</span>
<span class="token comment">// 		LOG_FTP FTP 协议信息</span>
<span class="token comment">// 		LOG_NEWS 新信息</span>
<span class="token comment">// 		LOG_LOCAL_0 ~ LOGLOCAL_7 本地保留</span>
<span class="token comment">// option</span>
<span class="token comment">//		LOG_CONS 如果不能发送给 syslogd，则将错误信息发送到控制台</span>
<span class="token comment">//		LOG_NDELAY 不延迟打开套接字，而是立即创建套接字，发送消息</span>
<span class="token comment">//		LOG_PERROR 将消息发送到标准错误文件，同时发送给 syslogd</span>
<span class="token comment">//		LOG_PID 再每个信息中增加进程的进程号</span>



<span class="token keyword">void</span> <span class="token function">syslog</span><span class="token punctuation">(</span><span class="token keyword">int</span> priority<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// priority 报文优先级</span>
<span class="token comment">//			LOG_EMERG 非常紧急，广播给所有用户</span>
<span class="token comment">//			LOG_ALART 立即纠正的错误</span>
<span class="token comment">//			LOG_CRIT 紧急的错误，通常是硬件错误</span>
<span class="token comment">//			LOG_ERR 需要注意的错误</span>
<span class="token comment">//			LOG_WARNING 警告，表示可能存在差错</span>
<span class="token comment">//			LOG_NOTICE 需要注意的情况</span>
<span class="token comment">//			LOG_INFO 某种消息报文</span>
<span class="token comment">//			LOG_DEBUG 程序员用于调试的报文</span>
<span class="token keyword">void</span> <span class="token function">closelog</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">vsyslog</span><span class="token punctuation">(</span><span class="token keyword">int</span> priority<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> va_list ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h2 id="_2-13-linux-进程间通信"><a href="#_2-13-linux-进程间通信" class="header-anchor">#</a> 2.13 Linux 进程间通信</h2> <p>早期进程间通信方式、system V IPC，BSD 套接字。</p> <p>通信方式：</p> <ul><li>单工，单工通信只支持信号在一个方向上传输（正向或反向），任何时候不能改变信号的传输方向。</li> <li>半双工，半双工通信允许信号在两个方向上传输，但某一时刻只允许信号在一个信道上单向传输。</li> <li>全双工，全双工通信允许数据同时在两个方向上传输，即有两个信道，因此允许同时进行双向传输。</li></ul> <h3 id="_2-13-1-早期进程间通信方式"><a href="#_2-13-1-早期进程间通信方式" class="header-anchor">#</a> 2.13.1 早期进程间通信方式</h3> <p><strong>（1）无名管道 pipe</strong></p> <p>特点：</p> <ul><li>只能用于具有亲缘关系的进程之间的通信。</li> <li>半双工的通信模式，具有固定的读端和写端。</li> <li>特殊文件，使用文件 I/O 读写。</li> <li>基于文件描述符，<code>fd[0]</code> 固定用于读管道，<code>fd[1]</code> 固定用于写管道。</li></ul> <p><img src="/linux/%E6%97%A0%E5%90%8D%E7%AE%A1%E9%81%93.png" alt=""></p> <p><img src="/linux/%E6%97%A0%E5%90%8D%E7%AE%A1%E9%81%93%E8%AF%BB%E5%86%99.png" alt=""></p> <p>函数原型</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">pipe</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 函数返回值：成功 0，失败 -1，并设置 errno</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>注意点：</p> <ul><li>管道中无数据时，读操作会阻塞。</li> <li>写数据时，linux 不保证写入的原子性，读进程不读走管道缓冲区中的数据，写操作会一直阻塞。</li> <li>只有在管道的读端存在时，向管道中写入数据才有意义。向管道中写入数据的的进程将收到内核传来的 SIFPIPE 信号。</li> <li>最多能写入 65536 字节。</li></ul> <p><strong>（2）有名管道 fifo</strong></p> <ul><li>管道文件主体在<strong>内核空间</strong>，用户空间映射的文件类型就是 p，大小永远为 0。</li> <li>可以使互不相关的两个进程互相通信，有名管道通过路径名来指出，在文件系统中可见。</li> <li>通过文件 I/O 操作有名管道。</li> <li>先进先出规则。</li> <li>不支持 lseek() 操作。</li></ul> <p>函数原型：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token class-name">mode_t</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 成功返回 0， 失败返回 -1，并置 errno</span>
<span class="token comment">// filename 要创建的管道。</span>
<span class="token comment">// mode 管道的访问权限。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>创建前判断</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span>F_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 创建管道文件</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>（3）信号 signal</strong></p> <p>异步：在异步模型中，允许同一时间发生（处理）多个事件。程序调用一个耗时较长的功能（方法）时，它并不会阻塞程序的执行流程，程序会继续往下执行。当功能执行完毕时，程序能够获得执行完毕的消息或能够访问到执行的结果（如果有返回值或需要返回值时）。</p> <p>信号是在软件层次上对中断机制的一种模拟，是一种异步通信方式。</p> <p>信号可以直接进行用户空间进程和内核进程之间的交互，内核进程也可以利用它来通知用户空间的进程发生了，了哪些系统事件。</p> <p>如果该进程当前并未处于执行态，则该信号就由内核保存起来，知道该进程恢复执行再传递给它，如果一个信号被进程设置为阻塞，则该信号的传递被延迟，直到其阻塞被取消时才被传递给进程。</p> <p><strong>信号的种类</strong></p> <p>1~31 非可靠信号，34 ~ 64 可靠信号，不可能丢失。</p> <p>POSIX.1 定义了下列信号：</p> <table><thead><tr><th style="text-align:center;">信号</th> <th style="text-align:center;">值</th> <th style="text-align:center;">动作</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;">SIGHUP</td> <td style="text-align:center;">1</td> <td style="text-align:center;">A</td> <td style="text-align:center;">在控制终端上是挂起信号, 或者控制进程结束</td></tr> <tr><td style="text-align:center;">SIGINT</td> <td style="text-align:center;">2</td> <td style="text-align:center;">A</td> <td style="text-align:center;">从键盘输入的中断C <code>c-c</code></td></tr> <tr><td style="text-align:center;">SIGQUIT</td> <td style="text-align:center;">3</td> <td style="text-align:center;">C</td> <td style="text-align:center;">从键盘输入的退出 <code>c-\</code></td></tr> <tr><td style="text-align:center;">SIGILL</td> <td style="text-align:center;">4</td> <td style="text-align:center;">C</td> <td style="text-align:center;">无效硬件指令</td></tr> <tr><td style="text-align:center;">SIGABRT</td> <td style="text-align:center;">6</td> <td style="text-align:center;">C</td> <td style="text-align:center;">非正常终止, 可能来自 abort(3)</td></tr> <tr><td style="text-align:center;">SIGFPE</td> <td style="text-align:center;">8</td> <td style="text-align:center;">C</td> <td style="text-align:center;">浮点运算例外</td></tr> <tr><td style="text-align:center;">SIGKILL</td> <td style="text-align:center;">9</td> <td style="text-align:center;">AEF</td> <td style="text-align:center;">杀死进程信号</td></tr> <tr><td style="text-align:center;">SIGSEGV</td> <td style="text-align:center;">11</td> <td style="text-align:center;">C</td> <td style="text-align:center;">无效的内存引用</td></tr> <tr><td style="text-align:center;">SIGPIPE</td> <td style="text-align:center;">13</td> <td style="text-align:center;">A</td> <td style="text-align:center;">管道中止: 写入无人读取的管道</td></tr> <tr><td style="text-align:center;">SIGALRM</td> <td style="text-align:center;">14</td> <td style="text-align:center;">A</td> <td style="text-align:center;">来自 alarm(2) 的超时信号</td></tr> <tr><td style="text-align:center;">SIGTERM</td> <td style="text-align:center;">15</td> <td style="text-align:center;">A</td> <td style="text-align:center;">终止信号</td></tr> <tr><td style="text-align:center;">SIGUSR1</td> <td style="text-align:center;">30,10,16</td> <td style="text-align:center;">A</td> <td style="text-align:center;">用户定义的信号 1</td></tr> <tr><td style="text-align:center;">SIGUSR2</td> <td style="text-align:center;">31,12,17</td> <td style="text-align:center;">A</td> <td style="text-align:center;">用户定义的信号 2</td></tr> <tr><td style="text-align:center;">SIGCHLD</td> <td style="text-align:center;">20,17,18</td> <td style="text-align:center;">B</td> <td style="text-align:center;">子进程结束或停止</td></tr> <tr><td style="text-align:center;">SIGCONT</td> <td style="text-align:center;">19,18,25</td> <td style="text-align:center;"></td> <td style="text-align:center;">继续停止的进程</td></tr> <tr><td style="text-align:center;">SIGSTOP</td> <td style="text-align:center;">17,19,23</td> <td style="text-align:center;">DEF</td> <td style="text-align:center;">停止进程</td></tr> <tr><td style="text-align:center;">SIGTSTP</td> <td style="text-align:center;">18,20,24</td> <td style="text-align:center;">D</td> <td style="text-align:center;">终端上发出的停止信号<code>c-z</code></td></tr> <tr><td style="text-align:center;">SIGTTIN</td> <td style="text-align:center;">21,21,26</td> <td style="text-align:center;">D</td> <td style="text-align:center;">后台进程试图从控制终端(tty)输入</td></tr> <tr><td style="text-align:center;">SIGTTOU</td> <td style="text-align:center;">22,22,27</td> <td style="text-align:center;">D</td> <td style="text-align:center;">后台进程试图在控制终端(tty)输出</td></tr></tbody></table> <p><strong>信号的生存周期</strong></p> <p><img src="/linux/%E4%BF%A1%E5%8F%B7%E7%9A%84%E7%94%9F%E5%AD%98%E5%91%A8%E6%9C%9F.png" alt=""></p> <p><strong>用户进程对信号的响应方式：</strong></p> <ul><li>忽略信号：对信号不做处理，但是两个信号不能忽略：<code>SIGKILL</code> 和 <code>SIGSTOP</code>。</li> <li>捕捉信号，定义信号处理函数，当信号发生时，执行相应的处理函数。</li> <li>执行缺省操作：Linux 对每种信号都规定了默认操作。</li></ul> <p><img src="/linux/%E4%BF%A1%E5%8F%B7%E7%9A%84%E6%A3%80%E6%B5%8B%E4%B8%8E%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B.png" alt=""></p> <p><strong>使用信号的场合</strong></p> <ul><li>后台进程需要使用信号，如 xinetd。</li> <li>如果两个进程没有亲缘关系，无法使用无名管道。</li> <li>如果两个通信进程之一只能使用标准输入和标准输出，无法使用 FIFO。</li></ul> <table><thead><tr><th style="text-align:center;">信号名</th> <th style="text-align:center;">含义</th> <th style="text-align:center;">默认操作</th></tr></thead> <tbody><tr><td style="text-align:center;">SIGHUP</td> <td style="text-align:center;">该信号在用户终端连接(正常或非正常)结束时发出，通常是在终端的控制进程结束时，通知同一会话内的各个作业与控制终端不再关联。</td> <td style="text-align:center;">终止</td></tr> <tr><td style="text-align:center;">SIGINT</td> <td style="text-align:center;">该信号在用户键入INTR字符(通常是Ctrl-C)时发出，终端驱动程序发送此信号并送到前台进程中的<strong>每一个进程</strong>。</td> <td style="text-align:center;">终止</td></tr> <tr><td style="text-align:center;">SIGQUIT</td> <td style="text-align:center;">该信号和SIGINT类似，但由QUIT字符(通常是<code>Ctrl-\</code>)来控制。</td> <td style="text-align:center;">终止</td></tr> <tr><td style="text-align:center;">SIGILL</td> <td style="text-align:center;">该信号在一个进程企图执行一条非法指令时(可执行文件本身出现错误，或者试图执行数据段、堆栈溢出时)发出。</td> <td style="text-align:center;">终止</td></tr> <tr><td style="text-align:center;">SIGFPE</td> <td style="text-align:center;">该信号在发生致命的算术运算错误时发出。这里不仅包括浮点运算错误，还包括溢出及除数为0等其它所有的算术的错误。</td> <td style="text-align:center;">终止</td></tr> <tr><td style="text-align:center;">SIGKILL</td> <td style="text-align:center;">该信号用来立即结束程序的运行，并且不能被阻塞、处理和忽略。</td> <td style="text-align:center;">终止</td></tr> <tr><td style="text-align:center;">SIGALARM</td> <td style="text-align:center;">该信号当一个定时器到时的时候发出。</td> <td style="text-align:center;">终止</td></tr> <tr><td style="text-align:center;">SIGSTOP</td> <td style="text-align:center;">该信号用于暂停一个进程，且不能被阻塞、处理或忽略。</td> <td style="text-align:center;">暂停进程</td></tr> <tr><td style="text-align:center;">SIGTSTP</td> <td style="text-align:center;">该信号用于暂停交互进程，用户可键入SUSP字符(通常是Ctrl-Z)发出这个信号。</td> <td style="text-align:center;">暂停进程</td></tr> <tr><td style="text-align:center;">SIGCHLD</td> <td style="text-align:center;">子进程改变状态时，父进程会受到这个信号</td> <td style="text-align:center;">忽略</td></tr> <tr><td style="text-align:center;">SIGABORT</td> <td style="text-align:center;">该进程用于结束进程</td> <td style="text-align:center;">终止</td></tr></tbody></table> <p><strong>信号的发送和捕捉</strong></p> <p>函数原型：</p> <p>kill() 可以发送信号给进程或进程组，raise 可以允许进程向自己发送信号。</p> <p>alarm() 也称作闹钟函数，可以在进程中设置一个定时器，当定时器指定的时间到，内核就像进程发送 SIG_ALARM 信号。</p> <p>pause() 函数适用于将调用进程挂起直到收到信号为止。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">kill</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//		pid 正数：要接受信号的进程的进程号。</span>
<span class="token comment">//			0 和 pid 进程在同一个进程组的进程。</span>
<span class="token comment">//			-1 信号发给所有的进程表中的进程（除了进程号最大的进程外）</span>
<span class="token comment">//		返回值：成功 0，失败 -1</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">raise</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回值：第一次返回 0</span>
<span class="token comment">//		  之后返回剩余秒数</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">pause</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>信号的处理</strong></p> <ul><li>特定的信号始于相应的时间相联系的。</li> <li>一个进程可以设定对信号的相应方式。</li> <li>信号处理的主要方法有两种：signal() 函数，使用信号集函数组。</li></ul> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token class-name">sighandler_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">sighandler_t</span> <span class="token function">signal</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">,</span> <span class="token class-name">sighandler_t</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// signum：指定信号</span>
		<span class="token comment">// handler：SIG_IGN：忽略该信号</span>
		<span class="token comment">// 		SIG_DFL：采用系统默认方式处理信号</span>
		<span class="token comment">// 		自定义的信号处理回调函数。</span>

		<span class="token comment">// 返回值：成功返回设置之前的信号处理方式，失败返回 -1.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_2-13-2-system-v-ipc对象"><a href="#_2-13-2-system-v-ipc对象" class="header-anchor">#</a> 2.13.2 System V IPC对象</h3> <p><strong>IPC对象</strong></p> <p><img src="/linux/IPC%E5%AF%B9%E8%B1%A1.png" alt=""></p> <p>IPC 对象存在与内核中，多进程可以操作同一个 IPC 对象。</p> <p>内核为每个进程间通信维护一个结构体形式的IPC对象。该对象可以通过一个非负整数的IPC标识来引用。</p> <p>与文件描述符不同，文件描述符总是找当前系统中可用的最小的数，而IPC标识是持续加一的</p> <p>IPC标识是IPC对象在内核空间中的唯一性标识ID。</p> <p>IPC键值是IPC对象在用户空间中的唯一性标识ID。</p> <ul><li>无论何时，只要创建IPC对象，就必须指定一个键值。</li> <li>键值的数据类型在sys/types.h头文件中被定义为key_t，其原始类型就是长整型long。</li></ul> <p><code>ipcs -m/q/s</code> 在用户空间看到内核空间的对象。</p> <p><code>ipcrm -m/q/s no</code> 删除 IPC 对象。</p> <p><strong>（1）共享内存 share memory</strong></p> <p><strong>特点</strong></p> <ul><li>共享内存是一种最为高效的进程间通信方式，进程可以直接读写内存，而不需要任何数据的拷贝。</li> <li>为了在多个进程间交换信息，内核专门留了一块内存区，可以由需要访问的进程将其映射到自己的私有地址空间。</li> <li>进程就可以直接读写这一内存区而不需要进行数据拷贝，大大提高效率。</li> <li>由于多个进程共享一段内存，因此也需要靠某种同步机制，如互斥锁和信号量。</li></ul> <p><img src="/linux/%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E7%89%B9%E7%82%B9.png" alt=""></p> <p><strong>共享内存实现</strong></p> <ol><li>创建/打开共享内存。</li> <li>映射共享内存，即把指定的共享内存映射到进程的地址空间用于访问。</li> <li>撤销共享内存映射。</li> <li>删除共享内存对象。</li></ol> <p>创建内存后返回的数据结构，<code>/usr/include/linux/shm.h</code> 中定义如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code> <span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">ipc_perm</span>    shm_perm<span class="token punctuation">;</span>      <span class="token comment">/* operation perms */</span>
        <span class="token keyword">int</span>                shm_segsz<span class="token punctuation">;</span>     <span class="token comment">/* size of segment (bytes) */</span>
        __kernel_time_t    shm_atime<span class="token punctuation">;</span>     <span class="token comment">/* last attach time */</span>
        __kernel_time_t    shm_dtime<span class="token punctuation">;</span>     <span class="token comment">/* last detach time */</span>
        __kernel_time_t    shm_ctime<span class="token punctuation">;</span>     <span class="token comment">/* last change time */</span>
        __kernel_ipc_pid_t shm_cpid<span class="token punctuation">;</span>      <span class="token comment">/* pid of creator */</span>
        __kernel_ipc_pid_t shm_lpid<span class="token punctuation">;</span>      <span class="token comment">/* pid of last operator */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">short</span>     shm_nattch<span class="token punctuation">;</span>    <span class="token comment">/* no. of current attaches */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">short</span>     shm_unused<span class="token punctuation">;</span>    <span class="token comment">/* compatibility */</span>
        <span class="token keyword">void</span>               <span class="token operator">*</span>shm_unused2<span class="token punctuation">;</span> <span class="token comment">/* ditto - used by DIPC */</span>
        <span class="token keyword">void</span>               <span class="token operator">*</span>shm_unused3<span class="token punctuation">;</span> <span class="token comment">/* unused */</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><code>/usr/include/linux/ipc.h</code> 中：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">ipc_perm</span>
<span class="token punctuation">{</span>
<span class="token class-name">key_t</span>        key<span class="token punctuation">;</span>                        <span class="token comment">// 调用shmget()时给出的关键字</span>
<span class="token class-name">uid_t</span>           uid<span class="token punctuation">;</span>                      <span class="token comment">/*共享内存所有者的有效用户ID */</span>
<span class="token class-name">gid_t</span>          gid<span class="token punctuation">;</span>                       <span class="token comment">/* 共享内存所有者所属组的有效组ID*/</span>
<span class="token class-name">uid_t</span>          cuid<span class="token punctuation">;</span>                    <span class="token comment">/* 共享内存创建 者的有效用户ID*/</span>
<span class="token class-name">gid_t</span>         cgid<span class="token punctuation">;</span>                   <span class="token comment">/* 共享内存创建者所属组的有效组ID*/</span>
<span class="token keyword">unsigned</span> <span class="token keyword">short</span>   mode<span class="token punctuation">;</span>    <span class="token comment">/* Permissions + SHM_DEST和SHM_LOCKED标志*/</span>
unsignedshort    seq<span class="token punctuation">;</span>          <span class="token comment">/* 序列号*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>函数原型：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token class-name">key_t</span> key<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//		key: IPC_PRIVATE 系统自动分配 或 ftok 的返回值</span>
<span class="token comment">//			 使用IPC_PRIVATE创建的IPC对象, key值属性为 0，</span>
<span class="token comment">//			 和IPC对象的编号就没有了对应关系。这样毫无关系的进程，</span>
<span class="token comment">//			 就不能通过key值来得到IPC对象的编号（因为这种方式创建的IPC对象的key值都是0）。</span>
<span class="token comment">//			 ）int shmID=shmget(IPC_PRIVATE,len,IPC_CREAT|0600);</span>
<span class="token comment">//			 需要在父子进程都可见的地方调用（即在创建子进程之前），否则不能实现内存的共享。</span>
<span class="token comment">//		size: 共享内存区大小</span>
<span class="token comment">//		shmflg: 同 open 函数的权限位</span>
<span class="token comment">//				IPC_CREAT | 0666，如果不存在则新建，存在则打开。</span>
<span class="token comment">//				IPC_EXCL  只有在共享内存不存在的时候，新的共享内存才建立，否则产生错误。</span>
<span class="token comment">//		返回值：成功返回共享内存段标识符，失败返回 -1</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>

<span class="token class-name">key_t</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> proj_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//  系统建立IPC通讯（如消息队列、共享内存时）必须指定一个ID值。</span>
<span class="token comment">//			pathname: 文件名，必须存在且可访问。</span>
<span class="token comment">// 			proj_id 工程 id，虽然为int，但是只有8个比特被使用(0-255)。</span>
<span class="token comment">//			成功返回 key，失败返回 -1</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>

<span class="token comment">// 将给共享内存映射到用户空间，方便在用户空间操作</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">shmat</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>shmaddr<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//		shmid: 要映射的共享内存区标识符</span>
<span class="token comment">//		shmaddr: 将共享内存映射到指定地址。（若为 NULL，则表示由系统自动完成映射）</span>
<span class="token comment">//		shmflg: SHM_RDONLY 共享内存只读</span>
<span class="token comment">//				默认 0 共享内存可读写</span>
<span class="token comment">// 		返回值：成功返回映射后的地址，失败 -1</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>

<span class="token comment">// 删除用户空间的共享内存地址映射</span>
<span class="token keyword">int</span> <span class="token function">shmdt</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>shmaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 		shmaddr: 共享内存映射后的地址</span>
<span class="token comment">//		返回值：成功 0，失败 -1</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>

<span class="token comment">// 删除内核空间的共享内存对象</span>
<span class="token keyword">int</span> <span class="token function">shmctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//		shmid: 要操作的共享内存标识符。</span>
<span class="token comment">//		cmd：IPC_STAT 获取对象属性    相当于 ipcs -m</span>
<span class="token comment">//			 IPC_SET 设置对象属性</span>
<span class="token comment">//			 IPC_RMID 删除对象        相当与 ipcrm -m</span>
<span class="token comment">// 			 buf 指定 IPC_STAT/IPC_SET 时用于保存/设置属性</span>
<span class="token comment">//			成功返回 0，失败返回 -1</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p>创建共享内存举例：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdio.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdlib.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;sys/types.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;sys/shm.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;signal.h&quot;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> shmid<span class="token punctuation">;</span>

    shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>IPC_PRIVATE<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shmid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create shared memory fail\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create shared memory sucess, shmid = %d\n&quot;</span><span class="token punctuation">,</span> shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//在用户空间看到内核空间的对象</span>
    <span class="token comment">//system(&quot;ipcrm -m shmid&quot;);</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// 使用 ftok</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdio.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdlib.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;sys/types.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;sys/shm.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;signal.h&quot;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> shmid<span class="token punctuation">;</span>
    <span class="token keyword">int</span> key<span class="token punctuation">;</span>

    key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token string">&quot;./a.c&quot;</span><span class="token punctuation">,</span> <span class="token char">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create key fail\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create key sucess key = 0x%X\n&quot;</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> IPC_CREAT <span class="token operator">|</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shmid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create shared memory fail\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create shared memory sucess, shmid = %d\n&quot;</span><span class="token punctuation">,</span> shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//system(&quot;ipcrm -m shmid&quot;);</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>共享内存映射举例：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdio.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdlib.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;sys/types.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;sys/shm.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;signal.h&quot;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> shmid<span class="token punctuation">;</span>
    <span class="token keyword">int</span> key<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>

    key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token string">&quot;./a.c&quot;</span><span class="token punctuation">,</span> <span class="token char">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create key fail\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create key sucess key = 0x%X\n&quot;</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> IPC_CREAT <span class="token operator">|</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shmid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create shared memory fail\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create shared memory sucess, shmid = %d\n&quot;</span><span class="token punctuation">,</span> shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;shmat fail\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;shmat sucess\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//write share memory</span>
    <span class="token function">fgets</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//start read share memory</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;share memory data:%s\n&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//start read share memory again</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;share memory data:%s\n&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//system(&quot;ipcrm -m shmid&quot;);</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>删除共享内存举例：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdio.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdlib.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;sys/types.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;sys/shm.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;signal.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;string.h&quot;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> shmid<span class="token punctuation">;</span>
    <span class="token keyword">int</span> key<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>

    key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token string">&quot;./a.c&quot;</span><span class="token punctuation">,</span> <span class="token char">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create key fail\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create key sucess key = 0x%X\n&quot;</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> IPC_CREAT <span class="token operator">|</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shmid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create shared memory fail\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create shared memory sucess, shmid = %d\n&quot;</span><span class="token punctuation">,</span> shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;shmat fail\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;shmat sucess\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//write share memory</span>
    <span class="token function">fgets</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//start read share memory</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;share memory data:%s\n&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//start read share memory again</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;share memory data:%s\n&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//在用户空间删除共享内存的地址</span>
    <span class="token function">shmdt</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//memcpy(p, &quot;abcd&quot;, 4);  //执行这个语句会出现segment fault</span>

    <span class="token function">shmctl</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> IPC_RMID<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//会删除内核的共享内存对象</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p><strong>（2）消息队列 message queue</strong></p> <p>在进程间通信中，用户进程将数据传输到内核后，内核重新添加一些比如用户id、组id、读写进程的id和优先级等相关信息后打包成一个数据称为消息。</p> <ul><li>消息队列由消息队列 ID 来唯一标识。</li> <li>消息队列就是一个消息的列表，用户可以在消息队列中添加消息、读取消息。</li> <li>消息队列可以按照类型来发送/接受消息。</li> <li>消息队列数量会受到系统消息队列数量的限制。</li></ul> <p><img src="/linux/msg%E7%BB%93%E6%9E%84.png" alt=""></p> <p><strong>步骤</strong></p> <ol><li>创建/打开消息队列</li> <li>添加消息</li> <li>读取消息</li> <li>控制消息队列</li></ol> <p><strong>API</strong></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h&gt;</span></span>

<span class="token comment">// 创建/打开消息队列</span>
<span class="token keyword">int</span> <span class="token function">msgget</span><span class="token punctuation">(</span><span class="token class-name">key_t</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> msgflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//          key：key 值</span>
<span class="token comment">//          flag：消息队列的访问权限</span>
<span class="token comment">//                IPC_EXCL标识本身没有太大的意义，但是和IPC_CREAT标志一起使用可以用来保证所得的对象是新建的，而不是打开已有的对象。</span>
<span class="token comment">//          返回值：成功返回消息队列 ID，失败返回 -1</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">msgsnd</span><span class="token punctuation">(</span><span class="token keyword">int</span> msqid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>msgp<span class="token punctuation">,</span> <span class="token class-name">size_t</span> msgsz<span class="token punctuation">,</span> <span class="token keyword">int</span> msgflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//          msqid: 消息队列的 id</span>
<span class="token comment">//          msgp:  指向消息的指针，常用消息结构 msgbuf 如下：</span>
<span class="token keyword">struct</span> <span class="token class-name">msgbuf</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> mtype<span class="token punctuation">;</span>       <span class="token comment">/* message type, must be &gt; 0 */</span> 消息类型，结构体必须从这个域开始
    <span class="token keyword">char</span> mtext<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* message data */</span> 消息正文
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//          msgz: 发送的消息正文的字节数，nbytes = sizeof (struct mymessage) - sizeof(long)</span>
<span class="token comment">//          flag：IPC_NOWAIT 消息没有发送完成，函数也会立即返回。</span>
<span class="token comment">//                0 直到发送完成函数才返回。</span>
<span class="token comment">//          返回值：成功0，失败 -1</span>

<span class="token class-name">ssize_t</span> <span class="token function">msgrcv</span><span class="token punctuation">(</span><span class="token keyword">int</span> msqid<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>msgp<span class="token punctuation">,</span> <span class="token class-name">size_t</span> msgsz<span class="token punctuation">,</span> <span class="token keyword">long</span> msgtyp<span class="token punctuation">,</span><span class="token keyword">int</span> msgflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//              msqid: 消息队列 ID</span>
<span class="token comment">//              msgp： 接收消息的缓冲区</span>
<span class="token comment">//              size：要接收的消息的字节数，nbytes：消息缓存的大小，不包含mtype的大小。</span>
<span class="token comment">//              msgtype：0 接受消息队列中的第一个消息。</span>
<span class="token comment">//                       大于 0 接受消息队列中第一个类型为 msgtype 的消息。</span>
<span class="token comment">//                       小于 0：接受消息队列中类型不小于 msgtyp 的绝对值且类型值又最小的消息。</span>
<span class="token comment">//              flag： 0，若无消息函数会一直阻塞。</span>
<span class="token comment">//                     IPC_NOWAIT: 若没有消息，进程会立即返回 ENOMSG。</span>
<span class="token comment">//              返回值：成功返回接收到消息的长度，出错返回 -1。</span>

<span class="token keyword">int</span> <span class="token function">msgctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> msqid<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">msqid_ds</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//              msqid: 消息队列的队列 Id</span>
<span class="token comment">//              cmd： IPC_STAT 读取消息队列的属性，并将其保存在 buf 指向的缓冲区中。</span>
<span class="token comment">//                    IPC_SET: 设置消息队列的属性。这个值取自 buf 参数。</span>
<span class="token comment">//                    IPC_RMID: 从系统中删除消息队列</span>
<span class="token comment">//              buf：消息队列属性指针</span>
<span class="token comment">//              返回值：成功返回 0，失败 -1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>实例：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// msgrcv.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    <span class="token keyword">long</span> type<span class="token punctuation">;</span> <span class="token comment">//消息类型</span>
    <span class="token keyword">int</span> start<span class="token punctuation">;</span> <span class="token comment">//消息数据本身（包括了start和end）</span>
    <span class="token keyword">int</span> end<span class="token punctuation">;</span>
<span class="token punctuation">}</span> MSG<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Lack arguments: %s\n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">key_t</span> key <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> type <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获得指定的消息队列</span>
    <span class="token keyword">int</span> msq_id<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>msq_id <span class="token operator">=</span> <span class="token function">msgget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;msgget error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;msg id: %d\n&quot;</span><span class="token punctuation">,</span> msq_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    MSG m<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">msgrcv</span><span class="token punctuation">(</span>msq_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>MSG<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> IPC_NOWAIT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;msgrcv error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;type: %ld start: %d end: %d\n&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>type<span class="token punctuation">,</span> m<span class="token punctuation">.</span>start<span class="token punctuation">,</span> m<span class="token punctuation">.</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// msgsend.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h&gt;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    <span class="token keyword">long</span> type<span class="token punctuation">;</span> <span class="token comment">//消息类型</span>
    <span class="token keyword">int</span> start<span class="token punctuation">;</span> <span class="token comment">//消息数据本身（包括了start和end）</span>
    <span class="token keyword">int</span> end<span class="token punctuation">;</span>
<span class="token punctuation">}</span> MSG<span class="token punctuation">;</span>

<span class="token comment">/*
 * 往消息队列中发送消息
 */</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Lack arguments %s\n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">key_t</span> key <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;key: %d\n&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建消息队列</span>
    <span class="token keyword">int</span> msq_id<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>msq_id <span class="token operator">=</span> <span class="token function">msgget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> IPC_CREAT <span class="token operator">|</span> IPC_EXCL <span class="token operator">|</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;msgget error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;msq id: %d\n&quot;</span><span class="token punctuation">,</span> msq_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 定义要发送的消息</span>
    MSG m<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送消息到消息队列</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">msgsnd</span><span class="token punctuation">(</span>msq_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>MSG<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">,</span> IPC_NOWAIT<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;msgsnd error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发送后去获得消息队列中消息的总数</span>
    <span class="token keyword">struct</span> <span class="token class-name">msqid_ds</span> ds<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">msgctl</span><span class="token punctuation">(</span>msq_id<span class="token punctuation">,</span> IPC_STAT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ds<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;msgctl error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* msg_qnum：number of messages currently on queue */</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;total message: %ld\n&quot;</span><span class="token punctuation">,</span> ds<span class="token punctuation">.</span>msg_qnum<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p><strong>（3）信号灯 semaphore</strong></p> <p>又叫信号量。是不同进程间或一个给定进程内部不同线程间同步的机制。</p> <p>信号灯种类：</p> <ul><li><p>posix 有名信号灯</p></li> <li><p>posix 基于内存的信号灯（无名信号灯）</p></li> <li><p>System V 信号灯（IPC 对象）</p></li> <li><p>二值信号灯：值位 0 或 1。与互斥锁类似，资源可用时值位不可用时值为0。</p></li> <li><p>计数信号灯：值在 0 到 n 之间。用来统计资源，其值代表可用资源数。</p></li> <li><p>等待操作是等待信号灯的值变为大于 0，然后将其减一。而释放操作则相反，用来唤醒等待资源的进程或者线程。</p></li></ul> <p><img src="/linux/%E4%BF%A1%E5%8F%B7%E7%81%AF.png" alt=""></p> <p><strong>System V 信号灯</strong></p> <ul><li>System V 信号灯是一个或者多个信号灯的一个集合。其中的每一个都是单独的计数信号灯。而 Posix 信号灯指的是单个计数信号灯。</li> <li>System V 信号灯由内核维护。</li></ul> <p>步骤：</p> <ol><li>创建或获取信号灯</li> <li>初始化信号灯</li> <li>PV 操作</li> <li>删除信号灯</li></ol> <p><strong>PV 操作</strong></p> <p>PV原子操作的具体定义如下：</p> <ul><li>P操作：如果有可用的资源（信号量值&gt;0），则占用一个资源（给信号量值减1，进入临界区代码）；如果没有可用的资源（信号量值=0），则被阻塞直到系统将资源分配给该进程（进入等待队列，一直等到资源轮到该进程）。</li> <li>V操作：如果在该信号量的等待队列中有进程在等待资源，则唤醒一个阻塞进程；如果没有进程等待它，则释放一个资源（给信号量值加1）。其中等待操作是等待信号灯的值变为大于0，然后将其减1；而释放操作则相反，用来唤醒等待资源的进程或线程。</li></ul> <p>常用的信号量访问临界区的伪代码：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{　　/* 设R为某种资源，S为资源R的信号量 */
　　INIT_VAL(S);    /* 对信号量S进行初始化 */
　　非临界区;
　　P(S);    /* 进行P操作 */
　　临界区（使用资源R）;    /* 只有有限个（通常只有一个）进程被允许进入该区 */
　　V(S);    /* 进行V操作 */
　　非临界区;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><img src="/linux/%E4%BF%A1%E5%8F%B7%E7%81%AF%E5%BA%94%E7%94%A8.png" alt=""></p> <p><strong>API</strong></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sem.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">semget</span><span class="token punctuation">(</span><span class="token class-name">key_t</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> nsems<span class="token punctuation">,</span> <span class="token keyword">int</span> semflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//          nsems 信号灯的个数</span>
<span class="token comment">//          semflg IPC_CREAT | 0666 创建，权限</span>
<span class="token comment">//          返回值：成功返回信号灯集semid，失败返回 -1，并设置错误码</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sem.h&gt;</span></span>

<span class="token comment">// PV 操作</span>
<span class="token keyword">int</span> <span class="token function">semop</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sembuf</span> opsptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nops<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// opsptr 结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">sembuf</span> <span class="token punctuation">{</span>
    <span class="token keyword">short</span> sem_num<span class="token punctuation">;</span> <span class="token comment">// 要操作的信号灯的编号</span>
    <span class="token keyword">short</span> sem_op<span class="token punctuation">;</span>  <span class="token comment">// 0 : 等待，直到信号灯的值变成0</span>
                   <span class="token comment">//  1 : 释放资源，V操作</span>
                   <span class="token comment">//  -1 : 分配资源，P操作</span>
    <span class="token keyword">short</span> sem_flg<span class="token punctuation">;</span> <span class="token comment">// 0, IPC_NOWAIT, SEM_UNDO，通常为SEM_UNDO ，这样在进程没释放信号量而退出时，系统自动释放该进程中未释放的信号量。</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// nops 要操作的信号灯个数</span>
<span class="token comment">// 返回值：成功0，失败 -1</span>

<span class="token comment">// 删除信号灯</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sem.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">semctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">,</span> <span class="token keyword">int</span> semnum<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token comment">// semid 信号灯集 ID</span>
<span class="token comment">// 要修改的信号灯编号</span>
<span class="token comment">// cmd GETVAL: 获取信号灯的值</span>
<span class="token comment">//     SETVAL: 设置信号灯的值</span>
<span class="token comment">//     IPC_RMID: 从系统中删除信号灯集合</span>
<span class="token comment">// 返回值：成功0，失败 -1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">:</span>
    IPC_RMID<span class="token operator">:</span><span class="token constant">NULL</span>
    GETVAL<span class="token operator">:</span><span class="token constant">NULL</span>
    SETVAL<span class="token operator">:</span>联合体：

<span class="token keyword">union</span> semun <span class="token punctuation">{</span>
    <span class="token keyword">int</span>              val<span class="token punctuation">;</span>    <span class="token comment">/* Value for SETVAL */</span>
    <span class="token keyword">struct</span> <span class="token class-name">semid_ds</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span>    <span class="token comment">/* Buffer for IPC_STAT, IPC_SET */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span>  <span class="token operator">*</span>array<span class="token punctuation">;</span>  <span class="token comment">/* Array for GETALL, SETALL */</span>
    <span class="token keyword">struct</span> <span class="token class-name">seminfo</span>  <span class="token operator">*</span>__buf<span class="token punctuation">;</span>  <span class="token comment">/* Buffer for IPC_INFO
                                           (Linux-specific) */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>示例代码：</p> <p>父进程从键盘输入字符串到共享内存，子进程删除字符串中的空格并打印，父进程输入quit后删除共享内存和信号灯集，程序结束</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sem.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N</span> <span class="token expression"><span class="token number">64</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">READ</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WRITE</span> <span class="token expression"><span class="token number">1</span></span></span>

<span class="token keyword">union</span> semun <span class="token punctuation">{</span>
  <span class="token keyword">int</span> val<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">semid_ds</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span>array<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">seminfo</span> <span class="token operator">*</span>__buf<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">init_sem</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">,</span> <span class="token keyword">int</span> s<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  <span class="token keyword">union</span> semun myun<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    myun<span class="token punctuation">.</span>val <span class="token operator">=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">semctl</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> i<span class="token punctuation">,</span> SETVAL<span class="token punctuation">,</span> myun<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">pv</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">sembuf</span> buf<span class="token punctuation">;</span>

  buf<span class="token punctuation">.</span>sem_num <span class="token operator">=</span> num<span class="token punctuation">;</span>
  buf<span class="token punctuation">.</span>sem_op <span class="token operator">=</span> op<span class="token punctuation">;</span>
  buf<span class="token punctuation">.</span>sem_flg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">semop</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> shmid<span class="token punctuation">,</span> semid<span class="token punctuation">,</span> s<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
  <span class="token class-name">key_t</span> key<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>shmaddr<span class="token punctuation">;</span>

  key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token char">'s'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;ftok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> N<span class="token punctuation">,</span> IPC_CREAT<span class="token operator">|</span><span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shmid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shmid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  semid <span class="token operator">=</span> <span class="token function">semget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> IPC_CREAT<span class="token operator">|</span><span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>semid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;semget&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> __ERROR1<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">init_sem</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  shmaddr <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shmaddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shmaddr&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> __ERROR2<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> __ERROR2<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">pv</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> READ<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      p <span class="token operator">=</span> q <span class="token operator">=</span> shmaddr<span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>q<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>q <span class="token operator">!=</span> <span class="token char">' '</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token operator">*</span>p<span class="token operator">++</span> <span class="token operator">=</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        q<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span> shmaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">pv</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> WRITE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">pv</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> WRITE<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;input &gt; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">fgets</span><span class="token punctuation">(</span>shmaddr<span class="token punctuation">,</span> N<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>shmaddr<span class="token punctuation">,</span> <span class="token string">&quot;quit\n&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token function">pv</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> READ<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> SIGUSR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

__ERROR2<span class="token operator">:</span>
  <span class="token function">semctl</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> IPC_RMID<span class="token punctuation">)</span><span class="token punctuation">;</span>
__ERROR1<span class="token operator">:</span>
  <span class="token function">shmctl</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> IPC_RMID<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br></div></div><h2 id="_2-14-进程间通信方式的比较"><a href="#_2-14-进程间通信方式的比较" class="header-anchor">#</a> 2.14 进程间通信方式的比较</h2> <ul><li>pipe：具有亲缘关系的进程间，单工，数据在内存中。</li> <li>fifo：可用于任意进程间，双工，有文件名，数据在内存。</li> <li>signal：唯一的异步通信方式。</li> <li>msg：常用于 cs 模式中，按消息类型访问，有优先级。</li> <li>shm：效率最高，需要同步、互斥机制。</li> <li>sem：配合共享内存使用，用以实现同步和互斥。</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">2023/4/19 20:48:31</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/wiki/Linux/unix-programing/unix-pro01.html" class="prev">
        01 文件 I/O
      </a></span> <span class="next"><a href="/wiki/Linux/unix-programing/unix-pro03.html">
        03 多线程编程
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/wiki/assets/js/app.a9cbc012.js" defer></script><script src="/wiki/assets/js/2.4b7299de.js" defer></script><script src="/wiki/assets/js/12.a18f7714.js" defer></script>
  </body>
</html>
