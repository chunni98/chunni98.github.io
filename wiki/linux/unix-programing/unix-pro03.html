<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>03 多线程编程 | CS Wiki</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="shachi 的 CS 知识库">
    
    <link rel="preload" href="/wiki/assets/css/0.styles.40ef89a5.css" as="style"><link rel="preload" href="/wiki/assets/js/app.6005c093.js" as="script"><link rel="preload" href="/wiki/assets/js/2.4b7299de.js" as="script"><link rel="preload" href="/wiki/assets/js/13.e0d914e3.js" as="script"><link rel="prefetch" href="/wiki/assets/js/10.023c6faa.js"><link rel="prefetch" href="/wiki/assets/js/11.f71b8eb3.js"><link rel="prefetch" href="/wiki/assets/js/12.0e6853b3.js"><link rel="prefetch" href="/wiki/assets/js/14.8bdf7c13.js"><link rel="prefetch" href="/wiki/assets/js/15.9e0345c7.js"><link rel="prefetch" href="/wiki/assets/js/16.a1d1e6c3.js"><link rel="prefetch" href="/wiki/assets/js/17.58c9759b.js"><link rel="prefetch" href="/wiki/assets/js/18.a135b98c.js"><link rel="prefetch" href="/wiki/assets/js/19.b404a248.js"><link rel="prefetch" href="/wiki/assets/js/20.dcb264c7.js"><link rel="prefetch" href="/wiki/assets/js/21.938790b5.js"><link rel="prefetch" href="/wiki/assets/js/22.2613edb8.js"><link rel="prefetch" href="/wiki/assets/js/23.014c43a0.js"><link rel="prefetch" href="/wiki/assets/js/24.b38bddd1.js"><link rel="prefetch" href="/wiki/assets/js/25.5db6c161.js"><link rel="prefetch" href="/wiki/assets/js/26.a0e63e72.js"><link rel="prefetch" href="/wiki/assets/js/27.c3efab24.js"><link rel="prefetch" href="/wiki/assets/js/28.f71e96f2.js"><link rel="prefetch" href="/wiki/assets/js/29.7f5d8683.js"><link rel="prefetch" href="/wiki/assets/js/3.6d633953.js"><link rel="prefetch" href="/wiki/assets/js/30.31775b12.js"><link rel="prefetch" href="/wiki/assets/js/31.9103ea9d.js"><link rel="prefetch" href="/wiki/assets/js/32.edd6a0fb.js"><link rel="prefetch" href="/wiki/assets/js/33.33c23cb6.js"><link rel="prefetch" href="/wiki/assets/js/34.fa89b974.js"><link rel="prefetch" href="/wiki/assets/js/35.578c57c3.js"><link rel="prefetch" href="/wiki/assets/js/36.61a4611a.js"><link rel="prefetch" href="/wiki/assets/js/37.35f00b52.js"><link rel="prefetch" href="/wiki/assets/js/38.56c36766.js"><link rel="prefetch" href="/wiki/assets/js/39.ed160d8b.js"><link rel="prefetch" href="/wiki/assets/js/4.2e33d51d.js"><link rel="prefetch" href="/wiki/assets/js/40.dd849684.js"><link rel="prefetch" href="/wiki/assets/js/41.0a126ce9.js"><link rel="prefetch" href="/wiki/assets/js/42.f055cc8b.js"><link rel="prefetch" href="/wiki/assets/js/43.ce48b1bc.js"><link rel="prefetch" href="/wiki/assets/js/44.500b5a4d.js"><link rel="prefetch" href="/wiki/assets/js/45.73aaa5c9.js"><link rel="prefetch" href="/wiki/assets/js/46.5ec1f340.js"><link rel="prefetch" href="/wiki/assets/js/47.1bd50fbc.js"><link rel="prefetch" href="/wiki/assets/js/48.39997210.js"><link rel="prefetch" href="/wiki/assets/js/49.3336d241.js"><link rel="prefetch" href="/wiki/assets/js/5.5b3fd24d.js"><link rel="prefetch" href="/wiki/assets/js/50.e2bfaa49.js"><link rel="prefetch" href="/wiki/assets/js/51.f2603124.js"><link rel="prefetch" href="/wiki/assets/js/52.521181ca.js"><link rel="prefetch" href="/wiki/assets/js/53.96ed2bb8.js"><link rel="prefetch" href="/wiki/assets/js/54.0e345e97.js"><link rel="prefetch" href="/wiki/assets/js/55.8af9a828.js"><link rel="prefetch" href="/wiki/assets/js/56.e97b21d9.js"><link rel="prefetch" href="/wiki/assets/js/57.64b3d1c4.js"><link rel="prefetch" href="/wiki/assets/js/58.2c7d3f71.js"><link rel="prefetch" href="/wiki/assets/js/59.6cbe62a0.js"><link rel="prefetch" href="/wiki/assets/js/6.3b848e60.js"><link rel="prefetch" href="/wiki/assets/js/60.7eda6d97.js"><link rel="prefetch" href="/wiki/assets/js/61.78598666.js"><link rel="prefetch" href="/wiki/assets/js/62.dc469974.js"><link rel="prefetch" href="/wiki/assets/js/63.7ca244a4.js"><link rel="prefetch" href="/wiki/assets/js/64.d4c4d0d6.js"><link rel="prefetch" href="/wiki/assets/js/65.5a26ec0e.js"><link rel="prefetch" href="/wiki/assets/js/7.c67aa8fa.js"><link rel="prefetch" href="/wiki/assets/js/8.431ae0d7.js"><link rel="prefetch" href="/wiki/assets/js/9.d2107a17.js">
    <link rel="stylesheet" href="/wiki/assets/css/0.styles.40ef89a5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/wiki/" class="home-link router-link-active"><img src="/wiki/favicon.ico" alt="CS Wiki" class="logo"> <span class="site-name can-hide">CS Wiki</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/wiki/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/wiki/archives/" class="nav-link">
  归档
</a></div><div class="nav-item"><a href="/wiki/c/" class="nav-link">
  C
</a></div><div class="nav-item"><a href="/wiki/cpp/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="/wiki/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          理论
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/wiki/data-structure/" class="nav-link">
  数据结构
</a></li><li class="dropdown-subitem"><a href="/wiki/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-subitem"><a href="/wiki/" class="nav-link">
  计算机组成原理
</a></li><li class="dropdown-subitem"><a href="/wiki/" class="nav-link">
  操作系统
</a></li><li class="dropdown-subitem"><a href="/wiki/" class="nav-link">
  数据库
</a></li><li class="dropdown-subitem"><a href="/wiki/" class="nav-link">
  编译原理
</a></li></ul></li><li class="dropdown-item"><h4>
          工具
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/wiki/tools/vim.html" class="nav-link">
  Vim
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/Makefile.html" class="nav-link">
  Makefile
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/shell.html" class="nav-link">
  shell
</a></li><li class="dropdown-subitem"><a href="/wiki/" class="nav-link">
  正则表达式
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/git.html" class="nav-link">
  git
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/gdb.html" class="nav-link">
  gdb
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/CMake.html" class="nav-link">
  CMake
</a></li><li class="dropdown-subitem"><a href="https://github.com/chunni98/learn-python-with-lxf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Python3
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="嵌入式" class="dropdown-title"><span class="title">嵌入式</span> <span class="arrow down"></span></button> <button type="button" aria-label="嵌入式" class="mobile-dropdown-title"><span class="title">嵌入式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wiki/" class="nav-link">
  x86汇编
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/sqlite3.html" class="nav-link">
  sqlite3
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/stm32/" class="nav-link">
  stm32
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/collections.html" class="nav-link">
  问题集
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/learn-arm.html" class="nav-link">
  ARM 体系结构
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/driver/" class="nav-link">
  Linux 内核驱动
</a></li></ul></div></div><div class="nav-item"><a href="https://chunni98.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/wiki/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/wiki/archives/" class="nav-link">
  归档
</a></div><div class="nav-item"><a href="/wiki/c/" class="nav-link">
  C
</a></div><div class="nav-item"><a href="/wiki/cpp/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="/wiki/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          理论
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/wiki/data-structure/" class="nav-link">
  数据结构
</a></li><li class="dropdown-subitem"><a href="/wiki/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-subitem"><a href="/wiki/" class="nav-link">
  计算机组成原理
</a></li><li class="dropdown-subitem"><a href="/wiki/" class="nav-link">
  操作系统
</a></li><li class="dropdown-subitem"><a href="/wiki/" class="nav-link">
  数据库
</a></li><li class="dropdown-subitem"><a href="/wiki/" class="nav-link">
  编译原理
</a></li></ul></li><li class="dropdown-item"><h4>
          工具
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/wiki/tools/vim.html" class="nav-link">
  Vim
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/Makefile.html" class="nav-link">
  Makefile
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/shell.html" class="nav-link">
  shell
</a></li><li class="dropdown-subitem"><a href="/wiki/" class="nav-link">
  正则表达式
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/git.html" class="nav-link">
  git
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/gdb.html" class="nav-link">
  gdb
</a></li><li class="dropdown-subitem"><a href="/wiki/tools/CMake.html" class="nav-link">
  CMake
</a></li><li class="dropdown-subitem"><a href="https://github.com/chunni98/learn-python-with-lxf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Python3
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="嵌入式" class="dropdown-title"><span class="title">嵌入式</span> <span class="arrow down"></span></button> <button type="button" aria-label="嵌入式" class="mobile-dropdown-title"><span class="title">嵌入式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wiki/" class="nav-link">
  x86汇编
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/sqlite3.html" class="nav-link">
  sqlite3
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/stm32/" class="nav-link">
  stm32
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/collections.html" class="nav-link">
  问题集
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/learn-arm.html" class="nav-link">
  ARM 体系结构
</a></li><li class="dropdown-item"><!----> <a href="/wiki/emebedded/driver/" class="nav-link">
  Linux 内核驱动
</a></li></ul></div></div><div class="nav-item"><a href="https://chunni98.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/wiki/Linux/" aria-current="page" class="sidebar-link">Linux 笔记</a></li><li><a href="/wiki/Linux/learn-linux.html" class="sidebar-link">1 Linux 笔记</a></li><li><a href="/wiki/Linux/linux-collections.html" class="sidebar-link">2 Linux 问题集</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/wiki/Linux/unix-programing/" class="sidebar-heading clickable router-link-active open"><span>Unix 环境编程</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/wiki/Linux/unix-programing/unix-pro01.html" class="sidebar-link">01 文件 I/O</a></li><li><a href="/wiki/Linux/unix-programing/unix-pro02.html" class="sidebar-link">02 多进程编程</a></li><li><a href="/wiki/Linux/unix-programing/unix-pro03.html" aria-current="page" class="active sidebar-link">03 多线程编程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro03.html#_3-1-线程基础" class="sidebar-link">3.1 线程基础</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro03.html#_3-2-线程基础" class="sidebar-link">3.2 线程基础</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro03.html#_3-3-多线程编程" class="sidebar-link">3.3 多线程编程</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro03.html#_3-4-线程属性" class="sidebar-link">3.4 线程属性</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro03.html#_3-5-线程的同步和互斥" class="sidebar-link">3.5 线程的同步和互斥</a></li><li class="sidebar-sub-header"><a href="/wiki/Linux/unix-programing/unix-pro03.html#_3-6-条件变量" class="sidebar-link">3.6 条件变量</a></li></ul></li><li><a href="/wiki/Linux/unix-programing/unix-pro04.html" class="sidebar-link">04 网络编程</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>Linux使用pthread线程库来管理线程，因此编译的时候需要指定链接选项“-lpthread”，这是一个第三方库，其中“p”表示这个线程库遵循POSIX规范。</p> <h2 id="_3-1-线程基础"><a href="#_3-1-线程基础" class="header-anchor">#</a> 3.1 线程基础</h2> <ul><li><p>线程是内核调度的最小单元，也称作轻量级进程。</p></li> <li><p>每个用户进程都有自己的地址空间。</p></li> <li><p>系统为每个用户进程创建一个 task_struct 来描述进程。</p> <ul><li>该结构体中包含了一个指针指向该进程的虚拟地址空间映射表</li></ul></li> <li><p>实际上 task_struct 和地址空间映射表一起用来表示一个进程。</p></li> <li><p>由于进程的地址空间是私有的，因此在进程间上下文切换时，系统开销比较大。</p></li> <li><p>为了提高系统的性能，许多操作系统规范引入了线程概念。</p></li> <li><p>在同一个进程中创建的线程共享该进程的地址空间。</p></li> <li><p>Linux 同样用 task_struct 描述一个线程，线程和进程都参与统一的调度。</p></li> <li><p>通常线程指的是共享相同地址空间的多个任务。</p></li> <li><p>多线程的好处：</p> <ul><li>大大提高了任务切换的效率。</li> <li>避免了额外的 TLB &amp; cache 的刷新。</li></ul></li> <li><p>多线程通过第三方的线程库来实现。</p></li> <li><p>New POSIX Thread Library （NPTL）</p> <ul><li>早期 Linux  Threads 的改进。</li> <li>采用 1:1 的线程模型。</li> <li>显著提高了运行效率。</li> <li>信号处理效率更高。</li></ul></li></ul> <p><strong>多线程共享的资源</strong></p> <ol><li>可执行的指令</li> <li>静态数据</li> <li>进程中打开的文件描述符</li> <li>信号处理函数</li> <li>当前的工作目录</li> <li>用户 Id</li> <li>用户组 Id</li></ol> <p><strong>多线程私有资源</strong></p> <ol><li>线程 ID （tid）</li> <li>PC（程序计数器）和相关寄存器</li> <li>堆栈
<ol><li>局部变量</li> <li>返回地址</li></ol></li> <li>错误号</li> <li>信号掩码和优先级</li> <li>执行状态和属性</li></ol> <h2 id="_3-2-线程基础"><a href="#_3-2-线程基础" class="header-anchor">#</a> 3.2 线程基础</h2> <p><strong>NPTL线程库</strong></p> <ul><li>创建线程</li> <li>删除线程</li> <li>控制线程</li></ul> <p><strong>线程间同步和互斥机制</strong></p> <ul><li>信号量</li> <li>互斥锁</li> <li>条件变量</li></ul> <h2 id="_3-3-多线程编程"><a href="#_3-3-多线程编程" class="header-anchor">#</a> 3.3 多线程编程</h2> <p>编译多线程程序：</p> <p><code>gcc -o sample sample.c -lpthread -D_REENTRANT</code></p> <p><code>-D_REENTRANT</code> 生成可重入代码</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token comment">// 创建线程</span>
<span class="token keyword">int</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">pthread_attr_t</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span>
                          <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>start_routine<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                  thread:     创建的线程</span>
<span class="token comment">//                  attr        线程的属性，NULL 表示使用缺省属性</span>
<span class="token comment">//                  routine：   线程执行的函数</span>
<span class="token comment">//                  arg：       传递给线程执行的函数的参数</span>
<span class="token comment">//                  返回值：成功 0，失败错误码</span>

<span class="token comment">// 进程回收子线程，阻塞</span>
<span class="token keyword">int</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//              thread: 要等待的线程</span>
<span class="token comment">//              retval: 用户定义的指针，用来接收被等待线程结束时的返回值。</span>
<span class="token comment">//              返回值: 成功 0， 失败错误码</span>

<span class="token comment">// 线程退出</span>
<span class="token keyword">void</span> <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//              retval: 线程退出时返回值，可通过 pthread_join 函数接收。</span>

<span class="token comment">// 取消其他的线程</span>
<span class="token keyword">int</span> <span class="token function">pthread_cancel</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//          thread: 要取消的线程的标识符</span>
<span class="token comment">//          返回值：成功 0， 失败错误码</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="_3-4-线程属性"><a href="#_3-4-线程属性" class="header-anchor">#</a> 3.4 线程属性</h2> <p><code>pthread_attr_t *attr</code> 参数即代表线程的属性。线程的常用属性主要为：分离属性、堆栈大小以及调度策略和优先级。</p> <p>系统默认非分离、1Mb 的堆栈以及和主线程同样的调度策略和相同的优先级。</p> <p><strong>分离属性</strong></p> <p>分离属性是用来决定一个线程何时释放自己的资源。在非分离情况下，当一个线程结束时，它所占用的系统资源并没有释放，也就没有真正终止。只有当
<code>pthread_join()</code> 函数返回时，线程才能释放自己占用的系统资源。</p> <ol><li><code>pthread_attr_init()</code> 初始化，设置相应属性。</li> <li><code>pthread_attr_destroy()</code> 进行清理和回收。</li></ol> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token comment">// 初始化</span>
<span class="token keyword">int</span> <span class="token function">pthread_attr_init</span><span class="token punctuation">(</span><span class="token class-name">pthread_attr_t</span> <span class="token operator">*</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                  attr: 线程属性</span>
<span class="token comment">//                  返回值: 成功 0，失败错误码</span>

<span class="token comment">// 设置属性</span>
<span class="token keyword">int</span> <span class="token function">pthread_attr_setscope</span><span class="token punctuation">(</span><span class="token class-name">pthread_attr_t</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">int</span> detachstate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                      attr: 线程属性</span>
<span class="token comment">//                      detachstate:  PTHREAD_CREATE_JOINABLE 非分离</span>
<span class="token comment">//                                    PTHREAD_CREATE_DETACHED  分离</span>
<span class="token comment">//                      返回值：成功 0，失败 错误码</span>

<span class="token comment">// 设置调度参数</span>
<span class="token keyword">int</span> <span class="token function">pthread_attr_setschedparam</span><span class="token punctuation">(</span><span class="token class-name">pthread_attr_t</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span>
                                      <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sched_param</span> <span class="token operator">*</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                              attr: 线程属性</span>
<span class="token comment">//                              param: 调度参数</span>
<span class="token comment">//                              返回值：成功 0，失败非 0 错误码</span>

<span class="token comment">// 获取调度参数</span>
<span class="token keyword">int</span> <span class="token function">pthread_attr_getschedparam</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">pthread_attr_t</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span>
                                      <span class="token keyword">struct</span> <span class="token class-name">sched_param</span> <span class="token operator">*</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                              attr: 线程属性</span>
<span class="token comment">//                              param: 调度参数</span>
<span class="token comment">//                              返回值：成功 0，失败非 0 错误码</span>

<span class="token comment">// 清理和回收</span>
<span class="token keyword">int</span> <span class="token function">pthread_attr_destroy</span><span class="token punctuation">(</span><span class="token class-name">pthread_attr_t</span> <span class="token operator">*</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                      attr: 线程属性</span>
<span class="token comment">//                      返回值: 成功 0，失败 错误码</span>

<span class="token comment">// 线程 id</span>
<span class="token class-name">pthread_t</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 一定成功，返回 线程 tid</span>

<span class="token comment">// 设置线程为分离属性</span>
<span class="token keyword">int</span> <span class="token function">pthread_detach</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//pthread_detach() 函数用于分离指定的线程，使其处于分离状态。分离状态的线程资源会在线程结束时自动释放，而不需要调用 pthread_join() 函数。</span>

<span class="token comment">//调用 pthread_detach() 函数的线程必须与被分离的线程是同一个进程的，否则将返回 EINVAL 错误。</span>

<span class="token comment">//如果线程已经处于分离状态，则调用 pthread_detach() 函数将返回 EINVAL 错误。</span>

<span class="token comment">//成功执行 pthread_detach() 函数将返回 0，否则返回错误代码。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h2 id="_3-5-线程的同步和互斥"><a href="#_3-5-线程的同步和互斥" class="header-anchor">#</a> 3.5 线程的同步和互斥</h2> <ul><li>多线程共享同一个进程的地址空间</li> <li>优点：线程间很容易进行通信（通过全局变量实现数据共享和交换）</li> <li>缺点：多个线程同时访问共享对象时需要引入同步和互斥机制。</li></ul> <h3 id="_3-5-1-线程间同步"><a href="#_3-5-1-线程间同步" class="header-anchor">#</a> 3.5.1 线程间同步</h3> <ul><li>同步指的是多个线程按照约定的顺序相互配合完成一件事情。</li> <li>由信号量来决定线程继续运行还是阻塞等待。</li></ul> <h3 id="_3-5-2-p-v-操作"><a href="#_3-5-2-p-v-操作" class="header-anchor">#</a> 3.5.2 P/V 操作</h3> <ul><li>信号量代表一类资源，其值表示系统中该资源的数量。</li> <li>信号量是一个受保护的变量，只能通过三种操作来访问。
<ul><li>初始化</li> <li>P操作（申请资源）</li> <li>V操作（释放资源）</li></ul></li> <li>信号量的值为非负整数。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>P(S) 含义：

if(信号量的值大于 0) {
    申请资源的任务继续运行;
    信号量的值减一;
} else {
    申请资源的任务阻塞
}

V(S) 含义如下：

if(没有任务在等待资源) {
    信号量的值加一；
} else {
    唤醒第一个等待的任务，让其继续运行；
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_3-5-3-posix-信号量-api"><a href="#_3-5-3-posix-信号量-api" class="header-anchor">#</a> 3.5.3  POSIX 信号量 API</h3> <p>信号量适用于控制一个仅支持有限个用户的共享资源。</p> <ul><li>POSIX 定义了两种信号量。
<ul><li>无名信号量</li> <li>有名信号量</li></ul></li></ul> <p>常用信号量操作：</p> <ol><li>初始化</li> <li>p操作</li> <li>v操作</li> <li>获取信号量的值</li> <li>删除信号量</li></ol> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h&gt;</span></span>

<span class="token comment">// 初始化信号量</span>
<span class="token keyword">int</span> <span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token class-name">sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">,</span> <span class="token keyword">int</span> pshared<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//              sem: 初始化的信号量</span>
<span class="token comment">//              pshared: 信号量共享的范围（0：线程间使用，非 0: 进程间使用）</span>
<span class="token comment">//              value: 信号量初值</span>
<span class="token comment">//              返回值：成功 0 ，失败 -1</span>

<span class="token comment">// P 操作，获取信号量</span>
<span class="token keyword">int</span> <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token class-name">sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 成功 0 ，失败 -1</span>
<span class="token comment">// 若不成功，立即阻塞</span>

<span class="token comment">// V 操作，释放信号量</span>
<span class="token keyword">int</span> <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token class-name">sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 成功 0 ， 失败 -1</span>

<span class="token comment">// 删除信号量</span>
<span class="token keyword">int</span> <span class="token function">sem_destroy</span><span class="token punctuation">(</span><span class="token class-name">sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 成功 0 ，失败 -1</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_3-5-4-线程间互斥"><a href="#_3-5-4-线程间互斥" class="header-anchor">#</a> 3.5.4 线程间互斥</h3> <p>引入互斥锁的目的是用来保证共享数据操作的完整性。</p> <p>互斥锁主要用来保护临界资源，通过简单的加锁方法来保证对共享资源的原子操作。</p> <p>互斥锁只有两种状态：上锁和解锁，可以把互斥锁看成某种意义上的全局变量。</p> <p>每个临界资源都由一个互斥锁来保护，任何时刻最多只能有一个线程能访问该资源。</p> <p>线程必须先获得互斥锁才能访问临界资源，访问完资源后释放该锁。如果无法获得锁，线程会阻塞直到获得锁为止。</p> <p>互斥锁可以保证每个线程对共享资源按顺序进行原子操作。</p> <p><strong>POSIX Mutex API</strong></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h&gt;</span></span>

<span class="token comment">// 初始化 互斥锁</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">,</span>
                        <span class="token class-name">pthread_mutexattr_t</span> <span class="token operator">*</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                      mutex: 互斥锁</span>
<span class="token comment">//                      attr 互斥锁属性// NULL 表示缺省属性</span>
<span class="token comment">//                      返回值：成功 0 失败错误码</span>

<span class="token comment">// 申请互斥锁，不成功则阻塞，trylock,若不成功则返回</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                      mutex: 互斥锁</span>
<span class="token comment">//                      返回值：成功 0，失败-1</span>

<span class="token comment">//申请互斥锁，若不成功则返回</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutex_trylock</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                      mutex: 互斥锁</span>
<span class="token comment">//                      返回值：成功 0，失败-1</span>

<span class="token comment">// 释放互斥锁</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                      mutex: 互斥锁</span>
<span class="token comment">//                      返回值：成功 0，失败-1</span>

<span class="token keyword">int</span> <span class="token function">pthread_mutex_destory</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                      mutext: 互斥锁</span>
<span class="token comment">//                      删除互斥锁</span>
<span class="token comment">//                      返回值：成功 0 ，失败 -1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="_3-6-条件变量"><a href="#_3-6-条件变量" class="header-anchor">#</a> 3.6 条件变量</h2></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">2023/4/3 11:54:21</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/wiki/Linux/unix-programing/unix-pro02.html" class="prev">
        02 多进程编程
      </a></span> <span class="next"><a href="/wiki/Linux/unix-programing/unix-pro04.html">
        04 网络编程
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/wiki/assets/js/app.6005c093.js" defer></script><script src="/wiki/assets/js/2.4b7299de.js" defer></script><script src="/wiki/assets/js/13.e0d914e3.js" defer></script>
  </body>
</html>
